---
title: "Multi_salt_summary"
date: "22/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#Loading af pakker 
library(dplyr)
library(tidyr)
library(ggplot2)
library(visdat)
library(GGally)
library(Hmisc)
library(DMwR2)
library(data.table)
library(mltools)
library(ggfortify)
library(ggiraphExtra)
library(coronavirus)
library(lubridate)
library(plotly)
library(readxl)
require(readr)
library(zoo)
library(latex2exp)
library(fs)
```

Summary of Multi salt experiments.

All experiments were performed with:

Flux 20 LMH (permeate flow 17 mL/min)

Crossflow of 0.5 m/s (feed flow 1160 mL/min) 

The concentration of the various salts were selected based on concentration of authentic CT reservior water, it might have been diluted. 

<h3> Multi salt experiment with pH 9.2 </h3>

The pH was adjusted to pH 9.2 which is the lower end of the capacity for the bicarboante-carbonate buffer. 
The data has been collected every second and a rolling average have been applied to the data set, giving data every minute. 
The pressure started at 2.5 bar where it increased to about 2.8 bar over the course of the experiment.
The osmotic pressure will be calculated to determine if the increase in pressure is due to increase in the osmotic pressure on the feed side of the membrane or if it is due to fouling of the membrane. 



```{R pH 9.2 import data, echo=FALSE, message=FALSE}
CWF_Multi_9.2 = read_delim("data/Multi_9.2_19-10-2021_del2.csv",delim = "\t", escape_double = FALSE, 
                  trim_ws = TRUE, skip = 5) #Hente data og få det til passe ned i en tabel
#str(CWF)
dat_M_9.2 = as.data.frame(CWF_Multi_9.2) #Ændrer strukturen af dataen til noget vi kan arbejde med
old_names=colnames(CWF_Multi_9.2) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names=c("Time","level","con0201","pH0201","con0301","flow0301",
            "p0301","p0302","p0401","flow0401","p0501","con0501",
            "temp0501","p0601","temp0601","16","17","18","19","20",
            "21","pmp0201","pmp0301","pmp0401","pmp0501","flow_avg0301",
            "p_avg0301","p_avg0302","p_avg0401","flow_avg0401",
            "p_avg0501","FT0302","weight0302","flow0501","weight0501","36","pH0301",
            "pH0501","con0302","40") #Vi finder på nogle lidt bedre nogle
dat_M_9.2 = dat_M_9.2 %>% rename_at(vars(old_names),~new_names) #Vi ændrer navnene til de nye
dat_M_9.2$Time = dmy_hms(dat_M_9.2$Time)#Vi ændrer formatet af 'dato' kolonnen til et standard format for tid og datoer istedet for at det bare er noget tekst
#str(dat)



### Finde t=0 (fosøgsstart = der hvor flow er over 16 mL/min)
flow_boolean = dat_M_9.2$flow0501>16&dat_M_9.2$flow0501<25
start_tid = min(which(flow_boolean))
dat_M_9.2=dat_M_9.2[-c(1:start_tid),]
flow_boolean_slut = dat_M_9.2$flow0501<1
slut_tid = min(which(flow_boolean_slut))
dat_M_9.2=dat_M_9.2[-c(slut_tid:(nrow(dat_M_9.2)) ),]
### Tid i s fra forsøgs start
dat_M_9.2 = dat_M_9.2%>%
   mutate(sek=(
           as.numeric(as.POSIXct(dat_M_9.2$Time))-as.numeric(dat_M_9.2$Time[1], format='%Y-%m-%d %H:%M:%S'))
                )  

#import af iC og silica data. 
pH9.2_IC_data <- read_excel("data/Multi_salt_alle_change_pH.xlsx")

old_names_IC=colnames(pH9.2_IC_data) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names_IC=c("Time","Stream","Name","Sodium","Chloride","Sulphate","Calcium","Silica","DIT_M_Cl","Conductivity","pH","Dilution") #Vi finder på nogle lidt bedre nogle
pH9.2_IC_data = pH9.2_IC_data %>% rename_at(vars(old_names_IC),~new_names_IC) #Vi ændrer navnene til de nye
pH9.2_IC_data <- as.data.frame(pH9.2_IC_data)
pH9.2_IC_data <- pH9.2_IC_data[-c(14:22),] #cutter bicarbonat af. 

pH9.2_Permeate <- filter(pH9.2_IC_data, Stream=="Permeate")
pH9.2_Feed <- filter(pH9.2_IC_data, Stream=="Feed")
   

#pH9.2_rej_Cl <- (1-(pH9.2_Permeate$Chloride/(pH9.2_Feed$Chloride[-1])))*100
#pH9.2_rej_Na <- (1-(pH9.2_Permeate$Sodium/(pH9.2_Feed$Sodium[-1])))*100
#pH9.2_rej_Ca <- (1-(pH9.2_Permeate$Calcium/(pH9.2_Feed$Calcium[-1])))*100
#pH9.2_rej_SO4 <- (1-(pH9.2_Permeate$Sulphate/(pH9.2_Feed$Sulphate[-1])))*100
pH9.2_rej_SiO2 <- (1-(pH9.2_Permeate$Silica/(pH9.2_Feed$Silica[-1])))*100


```


```{R pH 10 import data, echo=FALSE, message=FALSE}
CWF_Multi_10 = read_delim("data/Multi_10_21_10_2021_del2.csv",delim = "\t", escape_double = FALSE, 
                  trim_ws = TRUE, skip = 5) #Hente data og få det til passe ned i en tabel
#str(CWF)
dat_M_10 = as.data.frame(CWF_Multi_10) #Ændrer strukturen af dataen til noget vi kan arbejde med
old_names=colnames(CWF_Multi_10) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names=c("Time","level","con0201","pH0201","con0301","flow0301",
            "p0301","p0302","p0401","flow0401","p0501","con0501",
            "temp0501","p0601","temp0601","16","17","18","19","20",
            "21","pmp0201","pmp0301","pmp0401","pmp0501","flow_avg0301",
            "p_avg0301","p_avg0302","p_avg0401","flow_avg0401",
            "p_avg0501","FT0302","weight0302","flow0501","weight0501","36","pH0301",
            "pH0501","con0302","40") #Vi finder på nogle lidt bedre nogle
dat_M_10 = dat_M_10 %>% rename_at(vars(old_names),~new_names) #Vi ændrer navnene til de nye
dat_M_10$Time = dmy_hms(dat_M_10$Time)#Vi ændrer formatet af 'dato' kolonnen til et standard format for tid og datoer istedet for at det bare er noget tekst
#str(dat)



### Finde t=0 (fosøgsstart = der hvor flow er over 16 mL/min)
flow_boolean = dat_M_10$flow0501>16&dat_M_10$flow0501<25
start_tid = min(which(flow_boolean))
dat_M_10=dat_M_10[-c(1:start_tid),]
flow_boolean_slut = dat_M_10$flow0501<1
slut_tid = min(which(flow_boolean_slut))
dat_M_10=dat_M_10[-c(slut_tid:(nrow(dat_M_10)) ),]
### Tid i s fra forsøgs start
dat_M_10 = dat_M_10%>%
   mutate(sek=(
           as.numeric(as.POSIXct(dat_M_10$Time))-as.numeric(dat_M_10$Time[1], format='%Y-%m-%d %H:%M:%S'))
                )  

#import af iC og silica data. 

pH10_IC_data <- read_excel("data/Multi_salt_alle_change_pH.xlsx",2)

old_names_IC=colnames(pH10_IC_data) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names_IC=c("Time","Stream","Name","Sodium","Chloride","Sulphate","Calcium","Silica","DIT_M_Cl") #Vi finder på nogle lidt bedre nogle
pH10_IC_data = pH10_IC_data %>% rename_at(vars(old_names_IC),~new_names_IC) #Vi ændrer navnene til de nye
pH10_IC_data <- as.data.frame(pH10_IC_data)
pH10_IC_data <- pH10_IC_data[-c(16:19),] #cutter bicarbonat af. 

pH10_Permeate <- filter(pH10_IC_data, Stream=="Permeate")
pH10_Feed <- filter(pH10_IC_data, Stream=="Feed")
   

#pH10_rej_Cl <- (1-(pH10_Permeate$Chloride/(pH10_Feed$Chloride[-1])))*100
#pH10_rej_Na <- (1-(pH10_Permeate$Sodium/(pH10_Feed$Sodium[-1])))*100
#pH10_rej_Ca <- (1-(pH10_Permeate$Calcium/(pH10_Feed$Calcium[-1])))*100
#pH10_rej_SO4 <- (1-(pH10_Permeate$Sulphate/(pH10_Feed$Sulphate[-1])))*100
pH10_rej_SiO2 <- (1-(pH10_Permeate$Silica/(pH10_Feed$Silica[-1])))*100

```

<h3> Comparison Pressure </h3>

NORMALISER I FORHOLD OSMOTISK TRYK. 

```{R Pressure, echo=FALSE, message=FALSE}


TMP_9.2<-(dat_M_9.2$p_avg0301+dat_M_9.2$p_avg0302)/2-dat_M_9.2$p_avg0501
  #TMP_slid_10<-rollapply(TMP,60,mean,align="right",fill=NA)
dat_M_9.2 <- cbind(dat_M_9.2,TMP_9.2)

TMP_10<-(dat_M_10$p_avg0301+dat_M_10$p_avg0302)/2-dat_M_10$p_avg0501
  #TMP_slid_10<-rollapply(TMP,60,mean,align="right",fill=NA)
dat_M_10 <- cbind(dat_M_10,TMP_10)

#klar til 10.5
#TMP_10.5<-(dat_M_10.5$p_avg0301+dat_M_10.5$p_avg0302)/2-dat_M_10.5$p_avg0501
  #TMP_slid_10.5<-rollapply(TMP,60,mean,align="right",fill=NA)
#dat_M_10.5 <- cbind(dat_M_10.5,TMP_10.5)


dat_M_9.2 %>%
  plot_ly(x=~(sek)/3600,
          y=~TMP_9.2,
          name="TMP pH 9.2",
          color='#00CC96',
          type='scatter',
          mode='lines')%>%
  add_lines(x=~(dat_M_10$sek)/3600,
          y=~dat_M_10$TMP_10,
          name='TMP pH 10',
          color='#636EFA')%>%
# add_lines(x=~(dat_M_10.5$sek)/3600,
#          y=~dat_M_10.5$TMP_10.5,
#          name='TMP pH 10.5',
#       color='#EF553B')%>%
  layout(title="TMP",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="Pressure [bar]", range=c(2,3.5)),
         xaxis=list(title="Time [h]")) #Her plottet TMP


``` 
```{R Recovery , include = FALSE, echo=FALSE, message=FALSE}
#definer start volumen for de respektive forsøg. 
initial_feed_volume_9.2 <- 10
initial_feed_volume_10 <- 8.5
initial_feed_volume_10.5 <- 10


csumflow0501_9.2 <- cumsum((dat_M_9.2$flow0501)/60)
dat_M_9.2 <- cbind(dat_M_9.2,csumflow0501_9.2)
csumflow0501_10 <- cumsum((dat_M_10$flow0501)/60)
dat_M_10 <- cbind(dat_M_10,csumflow0501_10)
#csumflow0501_10.5 <- cumsum((dat_M_10.5$flow0501)/60)
#dat_M_10.5 <- cbind(dat_M_10.5,csumflow0501_10.5)
perm_volume_9.2 <- tail(dat_M_9.2$csumflow0501_9.2, n=1)/1000
perm_volume_10 <- tail(dat_M_10$csumflow0501_10, n=1)/1000
#perm_volume_10.5 <- tail(dat_M_10.5$csumflow0501_10.5, n=1)/1000


```



pH of experiment    | 9.2               |      10         | 10.5
-------------       | -------------     | -------------   | -------------  
Total time [h]       | `r tail(dat_M_9.2$sek, n=1)/3600`|`r tail(dat_M_10$sek, n=1)/3600`| xx 
Average permeate flow [mL/min]|`r mean(dat_M_9.2$flow0501)`|`r mean(dat_M_10$flow0501)`| xx   
Total permeate volume [L]|`r perm_volume_9.2`|`r perm_volume_10`| xx   
Water Recovery % |`r (perm_volume_9.2/initial_feed_volume_9.2)*100`|`r (perm_volume_10/initial_feed_volume_10)*100`|xx



Comparison of permeate flow. 
The regulation valvue has been modified between experiment with pH 9.2 and experiment with pH 10 which might cause the difference in flucturations on the permeate flow. 

```{R Permeate flow ,  echo=FALSE, message=FALSE}


flow0501_slid_9.2 <- rollapply(dat_M_9.2$flow0501,60,mean,align="right",fill=NA)
dat_M_9.2 <- cbind(dat_M_9.2,flow0501_slid_9.2)

flow0501_slid_10 <- rollapply(dat_M_10$flow0501,60,mean,align="right",fill=NA)
dat_M_10 <- cbind(dat_M_10,flow0501_slid_10)

#klar til 10.5
#flow0501_slid_10.5 <- rollapply(dat_M_10.5$flow0501,60,mean,align="right",fill=NA)
#dat_M_10.5 <- cbind(dat_M_10.5,flow0501_slid_10.5)


dat_M_9.2 %>%
  plot_ly(x=~(sek)/3600,
          y=~flow0501_slid_9.2,
          name="Permeate flow pH 9.2",
          color='#00CC96',
          type='scatter',
          mode='lines')%>%
  add_lines(x=~(dat_M_10$sek)/3600,
          y=~dat_M_10$flow0501_slid_10,
          name='Permeate flow pH 10',
          color='#E41317')%>%
# add_lines(x=~(dat_M_10.5$sek)/3600,
 #         y=~dat_M_10.5$flow0501_slid_10.5,
#          name='Permeate flow pH 10.5',
#       color='#EF553B')%>%
  layout(title="Permeate Flow",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="Permeate Flow [mg/L]"),
         xaxis=list(title="Time [h]")) #Her plottet TMP




```


```{R Rejection of Silica ,  echo=FALSE, message=FALSE}



  plot_ly(x=~pH9.2_Feed$Time[-1],
          y=~pH9.2_rej_SiO2,
          name="SiO2 rejection pH 9.2",
          type='scatter',
          mode='marker',
          marker=list(color='#00CC96'))%>%
  add_markers(x=~pH10_Feed$Time[-1],
          y=~pH10_rej_SiO2,
          name='SiO2 rejection pH 10',
          type='scatter',
          mode='marker',
          marker=list(color='#636EFA'))%>%
# add_markers(x=~pH10.5_Feed$Time[-1],
 #         y=~pH10.5_rej_SiO2,
#          name='SiO2 rejection pH 10.5',
#          type='scatter',
#          mode='marker',
#       color='#EF553B')%>%
  layout(title="Rejection of Silica ",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="Rejection of SiO2[mg/L]"),
         xaxis=list(title="Time [h]")) #Her plottet TMP




```


```{R Rejection of Conductivity ,  echo=FALSE, message=FALSE}

con_rej_9.2<-(1-(dat_M_9.2$con0501/dat_M_9.2$con0301))*100
con_rej_9.2<- rollapplyr(con_rej_9.2, 60, mean, fill=NA)
dat_M_9.2 <- cbind(dat_M_9.2,con_rej_9.2)

con_rej_10<-(1-(dat_M_10$con0501/dat_M_10$con0301))*100
con_rej_10<- rollapplyr(con_rej_10, 60, mean, fill=NA)
dat_M_10 <- cbind(dat_M_10,con_rej_10)

#klar til 10.5
#con_rej_10.5<-(1-(dat_M_10.5$con0501/dat_M_10.5$con0301))*100
#con_rej_10.5<- rollapplyr(con_rej_10.5, 60, mean, fill=NA)
#dat_M_10.5 <- cbind(dat_M_10.5,con_rej_10.5)

dat_M_9.2 %>%
  plot_ly(x=~(sek)/3600,
          y=~con_rej_9.2,
          name=" pH 9.2",
          type='scatter',
          mode='line',
          line=list(color='#00CC96'))%>%
  add_lines(x=~(dat_M_10$sek)/3600,
          y=~dat_M_10$con_rej_10,
          name=' pH 10',
          type='scatter',
          mode='line',
          line=list(color='#636EFA'))%>%
#  add_lines(x=~(dat_M_10.5$sek)/3600,
#          y=~dat_M_10.5$con_rej_10,
#          name=' pH 10.5',
#          type='scatter',
#          mode='line',
#       color='#EF553B')%>%
  layout(title="Rejection of Conductivity",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="Rejection % ", range=c(0,100)),
         xaxis=list(title="Time [h]",range=c(0,7.5))
         ) #Her plottet TMP






```



```{R pH ,  echo=FALSE, message=FALSE}


dat_M_9.2 %>%
  plot_ly(x=~(sek)/3600,
          y=~pH0201,
          name=" pH 9.2",
          type='scatter',
          mode='line',
          line=list(color= '#00CC96'))%>%
  add_lines(x=~(dat_M_10$sek)/3600,
          y=~dat_M_10$pH0201,
          name=' pH 10',
          type='scatter',
          mode='line',
          line=list(color='#636EFA'))%>%
# add_lines(x=~(dat_M_10.5$sek)/3600,
#          y=~dat_M_10.5$pH0201,
#          name=' pH 10.5',
#          type='scatter',
#          mode='line',
#       color='#EF553B')%>%
  layout(title="pH of feed",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="pH ", range=c(9,11)),
         xaxis=list(title="Time [h]",range=c(0,8))
         ) #Her plottet TMP

```


```{r}
1 + 1
knitr::knit_exit()
```