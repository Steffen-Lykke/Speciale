---
title: "Summary of Multisalt Experiments"
date: "22/10/2021"
output: 
  html_document:
    toc: true
    toc_depth: 3
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=F,message=F)
#Loading af pakker 
library(dplyr)
library(tidyr)
library(ggplot2)
library(visdat)
library(GGally)
library(Hmisc)
library(DMwR2)
library(data.table)
library(mltools)
library(ggfortify)
library(ggiraphExtra)
library(coronavirus)
library(lubridate)
library(plotly)
library(readxl)
require(readr)
library(zoo)
library(latex2exp)
library(fs)
library(fcuk)
library(xtable)
```

## Summary of Multi salt experiments. {.tabset}

### Overview

All experiments were performed with:

Flux 20 LMH (permeate flow 17 mL/min)

Crossflow of 0.5 m/s (feed flow 1160 mL/min)

The concentration of the various salts were selected based on concentration of authentic CT reservior water, see table below.
It was attempted to mimic the concentration of authentic CT reservoir water, the focus was on species: Na, Cl, SO4, Ca, Sio2 and HCO3.
The concentration of the various species was chosen based on possible salt combination and concentration.
A bicarbonate-carbonate buffer was used to achieve some buffer effect with range between pH 9.2-10.6.
Three different experiment were made with varying pH value of 9.2, 10 and 10.5.
This gave varying concentration og HCO3 and Na due to content in buffer species.

| Ion Species | Authentic CT water | pH 9.2 | pH 10 | pH 10.5 |
|-------------|--------------------|--------|-------|---------|
| Na [mM]     | 10.81              | 11.77  | 14.76 | 16.63   |
| Cl [mM]     | 2.48               | 2.50   | 2.50  | 2.50    |
| SO4 [mM]    | 0.64               | 0.70   | 0.70  | 0.70    |
| Ca [mM]     | 0.35               | 0.40   | 0.40  | 0.40    |
| SiO2 [mM]   | 0.68               | 0.70   | 0.70  | 0.70    |
| HCO3[mM]    | 7.29               | 6.07   | 3.08  | 1.21    |

The experiment will investigate the impact of change in pH on ion rejection.

```{R pH 9.2 import data, echo=FALSE, message=FALSE}
CWF_Multi_9.2 = read_delim("data/Multi_9.2_19-10-2021_del2.csv",delim = "\t", escape_double = FALSE, 
                  trim_ws = TRUE, skip = 5) #Hente data og få det til passe ned i en tabel
#str(CWF)
dat_M_9.2 = as.data.frame(CWF_Multi_9.2) #Ændrer strukturen af dataen til noget vi kan arbejde med
old_names=colnames(CWF_Multi_9.2) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names=c("Time","level","con0201","pH0201","con0301","flow0301",
            "p0301","p0302","p0401","flow0401","p0501","con0501",
            "temp0501","p0601","temp0601","16","17","18","19","20",
            "21","pmp0201","pmp0301","pmp0401","pmp0501","flow_avg0301",
            "p_avg0301","p_avg0302","p_avg0401","flow_avg0401",
            "p_avg0501","FT0302","weight0302","flow0501","weight0501","36","pH0301",
            "pH0501","con0302","40") #Vi finder på nogle lidt bedre nogle
dat_M_9.2 = dat_M_9.2 %>% rename_at(vars(old_names),~new_names) #Vi ændrer navnene til de nye
dat_M_9.2$Time = dmy_hms(dat_M_9.2$Time)#Vi ændrer formatet af 'dato' kolonnen til et standard format for tid og datoer istedet for at det bare er noget tekst
#str(dat)



### Finde t=0 (fosøgsstart = der hvor flow er over 16 mL/min)
flow_boolean = dat_M_9.2$flow0501>16&dat_M_9.2$flow0501<25
start_tid = min(which(flow_boolean))
dat_M_9.2=dat_M_9.2[-c(1:start_tid),]
flow_boolean_slut = dat_M_9.2$flow0501<1
slut_tid = min(which(flow_boolean_slut))
dat_M_9.2=dat_M_9.2[-c(slut_tid:(nrow(dat_M_9.2)) ),]
### Tid i s fra forsøgs start
dat_M_9.2 = dat_M_9.2%>%
   mutate(sek=(
           as.numeric(as.POSIXct(dat_M_9.2$Time))-as.numeric(dat_M_9.2$Time[1], format='%Y-%m-%d %H:%M:%S'))
                )  

#import af iC og silica data. 
pH9.2_IC_data <- read_excel("data/Multi_salt_alle_change_pH.xlsx")

old_names_IC=colnames(pH9.2_IC_data) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names_IC=c("Time","Stream","Name","Sodium","Chloride","Sulphate","Calcium","Silica","DIT_M_Cl","Dilution","Cl_total","Conductivity","pH") #Vi finder på nogle lidt bedre nogle
pH9.2_IC_data = pH9.2_IC_data %>% rename_at(vars(old_names_IC),~new_names_IC) #Vi ændrer navnene til de nye
pH9.2_IC_data <- as.data.frame(pH9.2_IC_data)
pH9.2_bi_data <- pH9.2_IC_data[c(17:19),c(1:4)] #bicarbonat data
pH9.2_IC_data <- pH9.2_IC_data[c(1:13),] #IC data 

pH9.2_Permeate <- filter(pH9.2_IC_data, Stream=="Permeate")
pH9.2_Feed <- filter(pH9.2_IC_data, Stream=="Feed")
   

#pH9.2_rej_Cl <- (1-(pH9.2_Permeate$Chloride/(pH9.2_Feed$Chloride[-1])))*100
#pH9.2_rej_Na <- (1-(pH9.2_Permeate$Sodium/(pH9.2_Feed$Sodium[-1])))*100
#pH9.2_rej_Ca <- (1-(pH9.2_Permeate$Calcium/(pH9.2_Feed$Calcium[-1])))*100
#pH9.2_rej_SO4 <- (1-(pH9.2_Permeate$Sulphate/(pH9.2_Feed$Sulphate[-1])))*100
pH9.2_rej_SiO2 <- (1-(pH9.2_Permeate$Silica/(pH9.2_Feed$Silica[-1])))*100


```

```{R pH 10 import data, echo=FALSE, message=FALSE}
CWF_Multi_10 = read_delim("data/Multi_10_21_10_2021_del2.csv",delim = "\t", escape_double = FALSE, 
                  trim_ws = TRUE, skip = 5) #Hente data og få det til passe ned i en tabel
#str(CWF)
dat_M_10 = as.data.frame(CWF_Multi_10) #Ændrer strukturen af dataen til noget vi kan arbejde med
old_names=colnames(CWF_Multi_10) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names=c("Time","level","con0201","pH0201","con0301","flow0301",
            "p0301","p0302","p0401","flow0401","p0501","con0501",
            "temp0501","p0601","temp0601","16","17","18","19","20",
            "21","pmp0201","pmp0301","pmp0401","pmp0501","flow_avg0301",
            "p_avg0301","p_avg0302","p_avg0401","flow_avg0401",
            "p_avg0501","FT0302","weight0302","flow0501","weight0501","36","pH0301",
            "pH0501","con0302","40") #Vi finder på nogle lidt bedre nogle
dat_M_10 = dat_M_10 %>% rename_at(vars(old_names),~new_names) #Vi ændrer navnene til de nye
dat_M_10$Time = dmy_hms(dat_M_10$Time)#Vi ændrer formatet af 'dato' kolonnen til et standard format for tid og datoer istedet for at det bare er noget tekst
#str(dat)



### Finde t=0 (fosøgsstart = der hvor flow er over 16 mL/min)
flow_boolean = dat_M_10$flow0501>16&dat_M_10$flow0501<25
start_tid = min(which(flow_boolean))
dat_M_10=dat_M_10[-c(1:start_tid),]
flow_boolean_slut = dat_M_10$flow0501<1
slut_tid = min(which(flow_boolean_slut))
dat_M_10=dat_M_10[-c(slut_tid:(nrow(dat_M_10)) ),]
### Tid i s fra forsøgs start
dat_M_10 = dat_M_10%>%
   mutate(sek=(
           as.numeric(as.POSIXct(dat_M_10$Time))-as.numeric(dat_M_10$Time[1], format='%Y-%m-%d %H:%M:%S'))
                )  

#import af iC og silica data. 

pH10_IC_data <- read_excel("data/Multi_salt_alle_change_pH.xlsx",2)

old_names_IC=colnames(pH10_IC_data) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names_IC=c("Time","Stream","Name","Sodium","Chloride","Sulphate","Calcium","Silica","DIT_M_Cl") #Vi finder på nogle lidt bedre nogle
pH10_IC_data = pH10_IC_data %>% rename_at(vars(old_names_IC),~new_names_IC) #Vi ændrer navnene til de nye
pH10_IC_data <- as.data.frame(pH10_IC_data)
pH10_bi_data <- pH10_IC_data[c(17:19),c(1:4)] #bicarbonat data
pH10_IC_data <- pH10_IC_data[c(1:15),] #IC data 


pH10_Permeate <- filter(pH10_IC_data, Stream=="Permeate")
pH10_Feed <- filter(pH10_IC_data, Stream=="Feed")
pH10_Feed$Time = as.numeric(pH10_Feed$Time) 

#pH10_rej_Cl <- (1-(pH10_Permeate$Chloride/(pH10_Feed$Chloride[-1])))*100
#pH10_rej_Na <- (1-(pH10_Permeate$Sodium/(pH10_Feed$Sodium[-1])))*100
#pH10_rej_Ca <- (1-(pH10_Permeate$Calcium/(pH10_Feed$Calcium[-1])))*100
#pH10_rej_SO4 <- (1-(pH10_Permeate$Sulphate/(pH10_Feed$Sulphate[-1])))*100
pH10_rej_SiO2 <- (1-(pH10_Permeate$Silica/(pH10_Feed$Silica[-1])))*100

```

```{R pH 10.5 import data, echo=FALSE, message=FALSE}
CWF_Multi_10.5 = read_delim("data/Multi_10.5_25_10_2021_del2.csv",delim = "\t", escape_double = FALSE, 
                  trim_ws = TRUE, skip = 5) #Hente data og få det til passe ned i en tabel
#str(CWF)
dat_M_10.5 = as.data.frame(CWF_Multi_10.5) #Ændrer strukturen af dataen til noget vi kan arbejde med
old_names=colnames(CWF_Multi_10.5) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names=c("Time","level","con0201","pH0201","con0301","flow0301",
            "p0301","p0302","p0401","flow0401","p0501","con0501",
            "temp0501","p0601","temp0601","16","17","18","19","20",
            "21","pmp0201","pmp0301","pmp0401","pmp0501","flow_avg0301",
            "p_avg0301","p_avg0302","p_avg0401","flow_avg0401",
            "p_avg0501","FT0302","weight0302","flow0501","weight0501","36","pH0301",
            "pH0501","con0302","40") #Vi finder på nogle lidt bedre nogle
dat_M_10.5 = dat_M_10.5 %>% rename_at(vars(old_names),~new_names) #Vi ændrer navnene til de nye
dat_M_10.5$Time = dmy_hms(dat_M_10.5$Time)#Vi ændrer formatet af 'dato' kolonnen til et standard format for tid og datoer istedet for at det bare er noget tekst
#str(dat)



### Finde t=0 (fosøgsstart = der hvor flow er over 16 mL/min)
flow_boolean = dat_M_10.5$flow0501>16&dat_M_10.5$flow0501<25
start_tid = min(which(flow_boolean))
dat_M_10.5=dat_M_10.5[-c(1:start_tid),]
flow_boolean_slut = dat_M_10.5$flow0501<1
slut_tid = min(which(flow_boolean_slut))
dat_M_10.5=dat_M_10.5[-c(slut_tid:(nrow(dat_M_10.5)) ),]
### Tid i s fra forsøgs start
dat_M_10.5 = dat_M_10.5%>%
   mutate(sek=(
           as.numeric(as.POSIXct(dat_M_10.5$Time))-as.numeric(dat_M_10.5$Time[1], format='%Y-%m-%d %H:%M:%S'))
                )  

#import af iC og silica data. 

pH10.5_IC_data <- read_excel("data/Multi_salt_alle_change_pH.xlsx",3)

old_names_IC=colnames(pH10.5_IC_data) #Vi finder de latterlige navne kolonnerne i dataen har 
new_names_IC=c("Time","Stream","Name","Sodium","Chloride","Sulphate","Calcium","Silica","DIT_M_Cl", "Dilution","Cl_total") #Vi finder på nogle lidt bedre nogle
pH10.5_IC_data = pH10.5_IC_data %>% rename_at(vars(old_names_IC),~new_names_IC) #Vi ændrer navnene til de nye
pH10.5_IC_data <- as.data.frame(pH10.5_IC_data)
pH10.5_bi_data <- pH10.5_IC_data[c(17:19),c(1:4)] #bicarbonat data
pH10.5_IC_data <- pH10.5_IC_data[c(1:15),] #IC data 

pH10.5_Permeate <- filter(pH10.5_IC_data, Stream=="Permeate")
pH10.5_Feed <- filter(pH10.5_IC_data, Stream=="Feed")
pH10.5_Feed$Time = as.numeric(pH10.5_Feed$Time)    

#pH10.5_rej_Cl <- (1-(pH10.5_Permeate$Chloride/(pH10.5_Feed$Chloride[-1])))*10.50
#pH10.5_rej_Na <- (1-(pH10.5_Permeate$Sodium/(pH10.5_Feed$Sodium[-1])))*10.50
#pH10.5_rej_Ca <- (1-(pH10.5_Permeate$Calcium/(pH10.5_Feed$Calcium[-1])))*100
#pH10_rej_SO4 <- (1-(pH10_Permeate$Sulphate/(pH10_Feed$Sulphate[-1])))*100
pH10.5_rej_SiO2 <- (1-(pH10.5_Permeate$Silica/(pH10.5_Feed$Silica[-1])))*100

```

The pH was monitored in the feed stream with data logging every 1 sec.
The pH increase slightly for all filtration but at a similar rate, giving stable pH for comparison between filtration with different initial pH value.

```{R pH ,  echo=FALSE, message=FALSE}


dat_M_9.2 %>%
  plot_ly(x=~(sek)/3600,
          y=~pH0201,
          name=" pH 9.2",
          type='scatter',
          mode='line',
          line=list(color= '#00CC96'))%>%
  add_lines(x=~(dat_M_10$sek)/3600,
          y=~dat_M_10$pH0201,
          name=' pH 10',
          type='scatter',
          mode='line',
          line=list(color='#636EFA'))%>%
add_lines(x=~(dat_M_10.5$sek)/3600,
          y=~dat_M_10.5$pH0201,
          name=' pH 10.5',
          type='scatter',
          mode='line',
      line=list(color='#EF553B'))%>%
  layout(title="pH of feed",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="pH ", range=c(9,11)),
         xaxis=list(title="Time [h]",range=c(0,8))
         ) #Her plottet TMP

```

```{R Recovery , include = FALSE, echo=FALSE, message=FALSE}
#definer start volumen for de respektive forsøg. 
initial_feed_volume_9.2 <- 10 #uden prøver 10.5.54
initial_feed_volume_10 <- 8.5 #uden prøver (8.5+0.54)
initial_feed_volume_10.5 <- 10


csumflow0501_9.2 <- cumsum((dat_M_9.2$flow0501)/60)
dat_M_9.2 <- cbind(dat_M_9.2,csumflow0501_9.2)
csumflow0501_10 <- cumsum((dat_M_10$flow0501)/60)
dat_M_10 <- cbind(dat_M_10,csumflow0501_10)
csumflow0501_10.5 <- cumsum((dat_M_10.5$flow0501)/60)
dat_M_10.5 <- cbind(dat_M_10.5,csumflow0501_10.5)
perm_volume_9.2 <- tail(dat_M_9.2$csumflow0501_9.2, n=1)/1000
perm_volume_10 <- tail(dat_M_10$csumflow0501_10, n=1)/1000
perm_volume_10.5 <- tail(dat_M_10.5$csumflow0501_10.5, n=1)/1000


```

The three different filtration have been performed with the same parameters, except that filtration with pH 10 had initial feed volume of 8.5 L which also lead to lower total filtration time at 6.6 hours compared to 8.6 hours for the filtration with pH 9.2 and 8.1 hours for filration with pH 10.5.
The shorter filtration time leads to lower water recovery.
When performing the experiment the feed container was run until nothing was left, and still only a recovery of 88 % was maximum obtained from filtration with pH 9.2.
When ending the experiment water exits the system presumably the water which were pushed in the pressure dampeners during filtration it is estimated that this volume is 250 mL.
This still leaves about 0.950 L, 1.6 L and 1.5 L from the filtration with pH 9.2, pH 10 and pH 10.5 to be lost.

WHERE DOES THE WATER GO???

| pH of experiment               | 9.2                                               | 10                                              | 10.5                                                |
|--------------------------------|---------------------------------------------------|-------------------------------------------------|-----------------------------------------------------|
| Total filtration time [h]      | `r tail(dat_M_9.2$sek, n=1)/3600`                 | `r tail(dat_M_10$sek, n=1)/3600`                | `r tail(dat_M_10.5$sek, n=1)/3600`                  |
| Average permeate flow [mL/min] | `r mean(dat_M_9.2$flow0501)`                      | `r mean(dat_M_10$flow0501)`                     | `r mean(dat_M_10.5$flow0501)`                       |
| Total permeate volume [L]      | `r perm_volume_9.2`                               | `r perm_volume_10`                              | `r perm_volume_10.5`                                |
| Water Recovery %               | `r (perm_volume_9.2/initial_feed_volume_9.2)*100` | `r (perm_volume_10/initial_feed_volume_10)*100` | `r (perm_volume_10.5/initial_feed_volume_10.5)*100` |
| Water lost for ever            | `r initial_feed_volume_9.2-perm_volume_9.2-0.250` | `r initial_feed_volume_10-perm_volume_10-0.250` | `r initial_feed_volume_10.5-perm_volume_10.5-0.250` |

The average permeate flow is the same for all experiments at 17 mL/min, which is what the system is regulated according to.
There are larger fluctuations in permeate flow for the experiment with pH 9.2 but after this experiment the regulation value was altered slightly, which is why there is less fluctuations in the remaining filtrations with pH 10 and 10.5.
The data has been collected every second and a rooling average have been calculated over 1 min.

```{R Permeate flow ,  echo=FALSE, message=FALSE}


flow0501_slid_9.2 <- rollapply(dat_M_9.2$flow0501,60,mean,align="right",fill=NA)
dat_M_9.2 <- cbind(dat_M_9.2,flow0501_slid_9.2)

flow0501_slid_10 <- rollapply(dat_M_10$flow0501,60,mean,align="right",fill=NA)
dat_M_10 <- cbind(dat_M_10,flow0501_slid_10)

flow0501_slid_10.5 <- rollapply(dat_M_10.5$flow0501,60,mean,align="right",fill=NA)
dat_M_10.5 <- cbind(dat_M_10.5,flow0501_slid_10.5)


dat_M_9.2 %>%
  plot_ly(x=~(sek)/3600,
          y=~flow0501_slid_9.2,
          name="Permeate flow pH 9.2",
          type='scatter',
          mode='lines',
          line=list(color= '#00CC96'))%>%
  add_lines(x=~(dat_M_10$sek)/3600,
          y=~dat_M_10$flow0501_slid_10,
          name='Permeate flow pH 10',
          line=list(color= '#636EFA'))%>%
 add_lines(x=~(dat_M_10.5$sek)/3600,
          y=~dat_M_10.5$flow0501_slid_10.5,
        name='Permeate flow pH 10.5',
        line=list(color= '#EF553B'))%>%
  layout(title="Permeate Flow",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="Permeate Flow [mg/L]"),
         xaxis=list(title="Time [h]")) #Her plottet TMP




```

<h3>

Pressure

</h3>

NORMALISER I FORHOLD OSMOTISK TRYK.

The data has been collected every second.
For filtration with pH 9.2 the pressure started at 2.5 bar where it increased to about 2.8 bar over the course of the experiment.
The filtration with pH of 10 had further increase in pressure for a shorter time frame, increasing to about 3 bar.
The filtration with pH of 10.5 the pressure increased further to about max of 3.5 bar.
This increase in pressure could indicate higher ion content on the feed side and thus increase in pressure due to osmotic pressure or fouling.
This higher pH give higher rejection.

```{R Pressure, echo=FALSE, message=FALSE}


TMP_9.2<-(dat_M_9.2$p_avg0301+dat_M_9.2$p_avg0302)/2-dat_M_9.2$p_avg0501
  #TMP_slid_10<-rollapply(TMP,60,mean,align="right",fill=NA)
dat_M_9.2 <- cbind(dat_M_9.2,TMP_9.2)

TMP_10<-(dat_M_10$p_avg0301+dat_M_10$p_avg0302)/2-dat_M_10$p_avg0501
  #TMP_slid_10<-rollapply(TMP,60,mean,align="right",fill=NA)
dat_M_10 <- cbind(dat_M_10,TMP_10)


TMP_10.5<-(dat_M_10.5$p_avg0301+dat_M_10.5$p_avg0302)/2-dat_M_10.5$p_avg0501
  #TMP_slid_10.5<-rollapply(TMP,60,mean,align="right",fill=NA)
dat_M_10.5 <- cbind(dat_M_10.5,TMP_10.5)


dat_M_9.2 %>%
  plot_ly(x=~(sek)/3600,
          y=~TMP_9.2,
          name="TMP pH 9.2",
          type='scatter',
          mode='lines',
          line=list(color= '#00CC96'))%>%
  add_lines(x=~(dat_M_10$sek)/3600,
          y=~dat_M_10$TMP_10,
          name='TMP pH 10',
          line=list(color= '#636EFA'))%>%
 add_lines(x=~(dat_M_10.5$sek)/3600,
          y=~dat_M_10.5$TMP_10.5,
          name='TMP pH 10.5',
       line=list(color= '#EF553B'))%>%
  layout(title="TMP",
         legend=list(x=0.1,y=0.9),
         yaxis=list(title="Pressure [bar]", range=c(2,4)),
         xaxis=list(title="Time [h]")) #Her plottet TMP


```

<h3>

Conductivity Rejection

</h3>

The rejection for filtration with pH 9.2 fluctuate with decrease from 56 % to 52% and increase back to 54 %.
The rejection of filtration with pH 10 slightly increase from 65 % - 70% rejection.
The rejection of filtration with pH 10.h slightly increase from 75 % - 78% rejection.

When comparing the rejection of conductivity between the filtration it correlates with data for pressure with higher rejection and higher increase in pressure of filtration with higher pH.

```{R Rejection of Conductivity ,  echo=FALSE, message=FALSE}

con_rej_9.2<-(1-(dat_M_9.2$con0501/dat_M_9.2$con0301))*100
con_rej_9.2<- rollapplyr(con_rej_9.2, 60, mean, fill=NA)
dat_M_9.2 <- cbind(dat_M_9.2,con_rej_9.2)

con_rej_10<-(1-(dat_M_10$con0501/dat_M_10$con0301))*100
con_rej_10<- rollapplyr(con_rej_10, 60, mean, fill=NA)
dat_M_10 <- cbind(dat_M_10,con_rej_10)


con_rej_10.5<-(1-(dat_M_10.5$con0501/dat_M_10.5$con0301))*100
con_rej_10.5<- rollapplyr(con_rej_10.5, 60, mean, fill=NA)
dat_M_10.5 <- cbind(dat_M_10.5,con_rej_10.5)

dat_M_9.2 %>%
  plot_ly(x=~(sek)/3600,
          y=~con_rej_9.2,
          name=" pH 9.2",
          type='scatter',
          mode='line',
          line=list(color='#00CC96'))%>%
  add_lines(x=~(dat_M_10$sek)/3600,
          y=~dat_M_10$con_rej_10,
          name=' pH 10',
          type='scatter',
          mode='line',
          line=list(color='#636EFA'))%>%
  add_lines(x=~(dat_M_10.5$sek)/3600,
          y=~dat_M_10.5$con_rej_10,
          name=' pH 10.5',
          type='scatter',
          mode='line',
       line=list(color='#EF553B'))%>%
  layout(title="Rejection of Conductivity",
         legend=list(x=0.7,y=0.2),
         yaxis=list(title="Rejection % ", range=c(0,100)),
         xaxis=list(title="Time [h]",range=c(0,7.4))
         ) #Her plottet TMP


```

### Bicarbonate

Bicarboante was analysed as total alkalinity.
Samples were only taken from feed stream and were taken at the start and end of teh filtration along with one sample takne in the middle of the experiments.
Generally the bicarboatne content increase despite pH.
The Bicarbonate content also increases almost linearly as the concentration of silica increases which  could indicate that the silica concentration affects the alkalinity analysis instead of a greater concentration of bicarbonate.


Here are the bicarbonate results as given by alkalinity, note the limit of ~1200 of the analysis
```{R Bicarbonate Feed,  echo=FALSE, message=FALSE}
hline <- function(y = 0, color = "black") {
  list(
    type = "line", 
    x0 = 0, 
    x1 = 1, 
    xref = "paper",
    y0 = y, 
    y1 = y, 
    line = list(color = color)
  )
}

pH9.2_bi_data$Sodium = as.numeric(pH9.2_bi_data$Sodium)
pH10_bi_data$Sodium = as.numeric(pH10_bi_data$Sodium)
pH10.5_bi_data$Sodium = as.numeric(pH10.5_bi_data$Sodium)

  plot_ly(x=~pH9.2_bi_data$Time,
          y=~pH9.2_bi_data$Sodium,
          name="pH 9.2",
          type='scatter',
          mode='lines+markers')%>%
  add_trace(x=~pH10_bi_data$Time,
          y=~pH10_bi_data$Sodium,
          name='pH 10',
          type='scatter',
          mode='lines+markers')%>%
 add_trace(x=~pH10.5_bi_data$Time,
         y=~pH10.5_bi_data$Sodium,
         name="pH 10.5",
         type='scatter',
         mode='lines+markers')%>%
  layout(title="Concentration of bicarbonate feed",
         legend=list(x=0.9,y=0.2),
         yaxis=list(title="Concentration Bicarboante [mg/L]",
                    range=c(0,1300)),
         xaxis=list(title="Time [h]"))%>%
  layout(shapes = list(hline(1220)))

    




```

Plotting all silica and bicarbonate concentrations are 1. very difficult to look at and 2. shows a trend of increasing bicarb content when silica increases
```{R Bicarbonate with Silica,  echo=FALSE, message=FALSE}
hline <- function(y = 0, color = "black") {
  list(
    type = "line", 
    x0 = 0, 
    x1 = 1, 
    xref = "paper",
    y0 = y, 
    y1 = y, 
    line = list(color = color)
  )
}

pH9.2_bi_data$Sodium = as.numeric(pH9.2_bi_data$Sodium)
pH10_bi_data$Sodium = as.numeric(pH10_bi_data$Sodium)
pH10.5_bi_data$Sodium = as.numeric(pH10.5_bi_data$Sodium)

pH9.2_silica = cbind(pH9.2_IC_data%>%filter(Stream == "Feed")%>%select(1),pH9.2_IC_data%>%filter(Stream == "Feed")%>%select(8))
pH9.2_silica$Time[1]=0
pH10_silica = cbind(pH10_IC_data%>%filter(Stream == "Feed")%>%select(1),pH10_IC_data%>%filter(Stream == "Feed")%>%select(8))
pH10.5_silica = cbind(pH10.5_IC_data%>%filter(Stream == "Feed")%>%select(1),pH10.5_IC_data%>%filter(Stream == "Feed")%>%select(8))
ay <- list(
      tickfont = list(color = "red"),
      overlaying = "y",
      side = "right",
      title = "Silica concentration")

fig= plot_ly(x=~pH9.2_bi_data$Time,
        y=~pH9.2_bi_data$Sodium,
        name="pH 9.2",
        type='scatter',
        mode='lines+markers')%>%
  add_trace(x=~pH10_bi_data$Time,
            y=~pH10_bi_data$Sodium,
            name='pH 10',
            type='scatter',
            mode='lines+markers')%>%
  add_trace(x=~pH10.5_bi_data$Time,
            y=~pH10.5_bi_data$Sodium,
            name="pH 10.5",
            type='scatter',
            mode='lines+markers')

fig = fig%>%
  add_trace(x=~pH9.2_silica$Time,
            y=~pH9.2_silica$Silica,
            yaxis = "y2",
            name='pH 9.2 Silica',
            type='scatter',
            mode='lines+markers')%>%
  add_trace(x=~pH10_silica$Time,
            y=~pH10_silica$Silica,
            yaxis = "y2",
            name='pH 10 Silica',
            type='scatter',
            mode='lines+markers')%>%
  add_trace(x=~pH10.5_silica$Time,
        y=~pH10.5_silica$Silica,
        yaxis = "y2",
        name='pH 10.5 Silica',
        type='scatter',
        mode='lines+markers')
  
fig <- fig %>% layout(
  title = "Concentration of bicarbonate feed",
  yaxis2 = ay,
  xaxis = list(title = "Time [h]"),
  yaxis = list(title = "Concentration Bicarboante [mg/L]",range=c(0,1300)),
  legend=list(x=0,y=1)
) %>%
  layout(
    plot_bgcolor = '#e5ecf6',
    xaxis = list(
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    ),
    yaxis = list(
      zerolinecolor = '#ffff',
      zerolinewidth = 2,
      gridcolor = 'ffff'
    )
  )

          
fig


```
Plotting the bicarbonate concentration as a function of silica shows linear relation for each of the experiments 8last 3 plots).
For the overall relations (plottet right below) the specific trend is more difficult to grasp
```{R Bicarbonate with Silica 2,  echo=FALSE, message=FALSE}
hline <- function(y = 0, color = "black") {
  list(
    type = "line", 
    x0 = 0, 
    x1 = 1, 
    xref = "paper",
    y0 = y, 
    y1 = y, 
    line = list(color = color)
  )
}

pH9.2_bi_data$bicarb = as.numeric(pH9.2_bi_data$Sodium)
pH10_bi_data$bicarb = as.numeric(pH10_bi_data$Sodium)
pH10.5_bi_data$bicarb = as.numeric(pH10.5_bi_data$Sodium)

pH9.2_silica = cbind(pH9.2_IC_data%>%filter(Stream == "Feed")%>%select(1),pH9.2_IC_data%>%filter(Stream == "Feed")%>%select(8))
pH9.2_silica$Time[1]=0
pH10_silica = cbind(pH10_IC_data%>%filter(Stream == "Feed")%>%select(1),pH10_IC_data%>%filter(Stream == "Feed")%>%select(8))
pH10.5_silica = cbind(pH10.5_IC_data%>%filter(Stream == "Feed")%>%select(1),pH10.5_IC_data%>%filter(Stream == "Feed")%>%select(8))

pH9.2_si_bi=data.frame(pH9.2_silica$Silica[c(1,4,7)],
                       pH9.2_bi_data$bicarb,
                       "pH9.2")

pH10_si_bi=data.frame(pH10_silica$Silica[c(1,4,8)],
                       pH10_bi_data$bicarb,
                      "pH10")

pH10.5_si_bi=data.frame(pH10.5_silica$Silica[c(1,5,7)],
                       pH10.5_bi_data$bicarb,
                       "pH10.5")
colnames(pH9.2_si_bi) = c("Silica", "bicarb","origin")
colnames(pH10_si_bi) = c("Silica", "bicarb","origin")
colnames(pH10.5_si_bi) = c("Silica", "bicarb","origin")

si_bi=rbind(pH9.2_si_bi,pH10_si_bi,pH10.5_si_bi)
model = lm(Silica ~ bicarb, data = si_bi)

pred.int <- predict(model, interval = "prediction")
si_bi <- cbind(si_bi, pred.int)
si_bi_long = si_bi %>% gather("silica","bicarb",origin)
ggplot(data = si_bi, aes(x=Silica,y=bicarb))+geom_point(aes(x=Silica,y=bicarb,color=origin))+geom_line(aes(x=Silica,y=bicarb,color=origin))+geom_smooth(method=glm,formula = y~x,color="black")


ggplot(data = pH9.2_si_bi, aes(x=Silica,y=bicarb))+geom_point()+geom_smooth(method=glm,formula = y~x)
ggplot(data = pH10_si_bi, aes(x=Silica,y=bicarb))+geom_point()+geom_smooth(method=glm,formula = y~x)
ggplot(data = pH10.5_si_bi, aes(x=Silica,y=bicarb))+geom_point()+geom_smooth(method=glm,formula = y~x)
```

### Chloride DIT-M

From the results achieved with DIT-M photometer nothing can be concluded regarding trends due to very high error bars.
The errorbars are so high it cannot be distinguesed between different samples.
The high errorbars is the results of very high dilution factor at 25 as well as uncertainty of the instrument of 3 mg/L.
Furthermore all measured samples are much higher than the theroretical calcuclated initial feed value at 88 mg/L (included as horizontal dashed line).

```{R Chloride with DIT-M ,  echo=FALSE, message=FALSE}
pH9.2_IC_data[ pH9.2_IC_data == 0] <-NA

ggplot()+
  geom_point(data=pH9.2_IC_data, aes(x=Time, y=(DIT_M_Cl*Dilution), col=Stream), shape= 16)+
  geom_errorbar(data=pH9.2_IC_data, aes(x=Time,ymin=Cl_total-75,ymax=Cl_total+75, col=Stream))+
  geom_hline(yintercept=88, linetype="dashed", color = "black")+
  geom_text(aes(5,58,label = "Assumed correct start conc", vjust = -1))+
  labs(x="Time [h]",y=" Concentration [mg/L]")+
  ylim(0,350)+xlim(0,9.5)+
  ggtitle("Concentration of Chloride measured with DIT-M ph 9.2")

```

### Ion Rejections

#### Rejection of Silica

The rejection of silica correlates with rejection of over all conductivity where higher pH lead to higher rejection of silica.
Filtration with pH 9.2 have rejection of 21 % increasing to 27 %, with a presumed outlier at 6 h.
Filtration with pH 10 have significantly higher rejection of 49 % increasing to 58 %.
The rejectino of filtration with pH 10.5 so only slighly higher with rejection of 65 % increasing to 72 %.
Overall the silica rejetion is lower than the genereal conductivity rejection.
inducating that the pH influence other ions differently.

```{R Rejection of Silica ,  echo=FALSE, message=FALSE}



  plot_ly(x=~pH9.2_Feed$Time[-1],
          y=~pH9.2_rej_SiO2,
          name="pH 9.2",
          type='scatter',
          mode='lines+markers')%>%
  add_trace(x=~pH10_Feed$Time[-1],
          y=~pH10_rej_SiO2,
          name='pH 10',
          type='scatter',
          mode='lines+markers')%>%
 add_trace(x=~pH10.5_Feed$Time[-1],
          y=~pH10.5_rej_SiO2,
          name='pH 10.5',
         type='scatter',
          mode='lines+markers')%>%
  layout(title="Rejection of Silica ",
         legend=list(x=0.7,y=0.5),
         yaxis=list(title="Rejection of SiO2 [%]"),
         xaxis=list(title="Time [h]")) #Her plottet TMP




```

#### IC results
The ion results were obtained by IC analysis of samples taken at various times from feed and permeate streams for each experiment.


##### pH 9.2
```{r Ions 9.2, echo=FALSE}
IC_9.2_raw = IC_9.2= as.data.frame(pH9.2_IC_data)
IC_9.2$Sodium = as.double(IC_9.2$Sodium)
IC9.2p=IC_9.2 %>% filter(Stream=="Permeate")%>%mutate(Sulphate=5)
IC9.2f=IC_9.2 %>% filter(Stream=="Feed")
IC_9.2 = rbind(IC9.2f,IC9.2p)
#IC_9.2$Sulphate = replace_na(IC_9.2$Sulphate,5)
M9.2=IC_9.2%>%filter(Stream =="Feed")%>%slice(-1)
IC_9.2 = IC_9.2%>%gather(key,value, Sodium,Chloride,Sulphate,Calcium)

IC_9.2$value = as.double(IC_9.2$value)
#IC_9.2 = IC_9.2%>%mutate(Rej = )
A=IC_9.2%>%filter(Stream == "Feed"& Time != 0)
B=IC_9.2%>%filter(Stream=="Permeate")
rejection = 1-B$value/A$value
#C_9.2=data.frame(matrix(ncol=3,nrow=length(rejection)))
C_9.2=data.frame()
C_9.2[1:length(rejection),1]=NA
C_9.2$time=A$Time
C_9.2$key=A$key
C_9.2$value=rejection
C_9.2=C_9.2[,2:4]

## Export af data

M9.2 = cbind(M9.2, C_9.2 %>% filter(key =="Chloride")%>%select("value"))
M9.2 = cbind(M9.2, C_9.2 %>% filter(key =="Sulphate")%>%select("value"))
M9.2 = cbind(M9.2, C_9.2 %>% filter(key =="Sodium")%>%select("value"))
M9.2 = cbind(M9.2, C_9.2 %>% filter(key =="Calcium")%>%select("value"))
sil_9.2 = data.frame(pH9.2_rej_SiO2/100)
M9.2 = cbind(M9.2,sil_9.2)



colnames(M9.2)=c("time","Stream","name","Na","Cl","SO4","Ca","SiO2_mgL","fuck","af","pls","conductivity","pH","Rej_Cl","Rej_SO4","Rej_Na","Rej_Ca","Rej_SiO2")
M9.2=M9.2%>%select(-c("Stream","fuck","af","pls"))
write.table(M9.2,file='data/M9.2_df.csv',col.names = T,row.names = F,sep="\t")
#write_csv(M9.2,file='data/M9.2_df.csv')


#all_ion_9.2 = rbind(C_9.2,sil_9.2)

IC_9.2 = na.omit(IC_9.2)
labs = c('Na','Ca','Cl','SO4')
#level_order = c('Sodium','Calcium','Chloride','Sulphate')
conc_9.2 = ggplot(IC_9.2%>%filter(Stream=="Feed"), aes(x=Time, y=value,color= key))+geom_point()+geom_line()+
  scale_color_brewer(palette= "Set1")+scale_y_continuous(limits = c(0,1200))+
  labs(x="Time [h]",y="Ion Concentration Feed  [mg/L]", color="")+
  ggtitle("Ion concentration Multisalt pH 9.2")
p_conc_9.2 =  ggplotly(conc_9.2) %>% layout(showlegend = FALSE)


rej_9.2=ggplot(C_9.2, aes(x=time, y=value,color= key))+geom_point()+geom_line()+geom_hline(yintercept=0)+
  scale_color_brewer(palette= "Set1")+scale_y_continuous(limits = c(-0.6,1))+
  labs(x="Time [h]",y="Rejection", color="")+xlim(c(0,NA))+
  ggtitle("pH 9.2")
ggplotly(rej_9.2)
```
##### pH 10
```{r Ions 10, echo=FALSE}
IC_10_raw = IC_10 = as.data.frame(pH10_IC_data)
IC_10 = slice(IC_10,-c(2,3))
IC10p=IC_10 %>% filter(Stream=="Permeate")%>%mutate(Sulphate=5)
IC10f=IC_10 %>% filter(Stream=="Feed")
IC_10 = rbind(IC10f,IC10p)
M10=IC_10%>%filter(Stream =="Feed")%>%slice(-1)
IC_10 = IC_10%>%gather(key,value, Sodium,Chloride,Sulphate,Calcium)

IC_10 = subset(IC_10,select=-5)
IC_10$value = as.double(IC_10$value)
IC_10$Time = as.double(IC_10$Time)
#IC_10 = IC_10%>%mutate(Rej = )
A=IC_10%>%filter(Stream == "Feed"& Time != 0)
B=IC_10%>%filter(Stream=="Permeate")
rejection = 1-B$value/A$value
C_10=data.frame(matrix(ncol=3,nrow=length(rejection)))
colnames(C_10)=c('time','key','value')
C_10$time=A$Time
C_10$key=A$key
C_10$value=rejection

## Export af data
M10 = cbind(M10, C_10 %>% filter(key =="Chloride")%>%select("value"))
M10 = cbind(M10, C_10 %>% filter(key =="Sulphate")%>%select("value"))
M10 = cbind(M10, C_10 %>% filter(key =="Sodium")%>%select("value"))
M10 = cbind(M10, C_10 %>% filter(key =="Calcium")%>%select("value"))
sil_10 = data.frame(pH10_rej_SiO2/100)
M10 = cbind(M10,sil_10[2:7,])



colnames(M10)=c("time","Stream","name","Na","Cl","SO4","Ca","SiO2_mgL","fuck","Rej_Cl","Rej_SO4","Rej_Na","Rej_Ca","Rej_SiO2")
M10=M10%>%select(-c("Stream","fuck"))
write.table(M10,file='data/M10_df.csv',col.names = T,row.names = F,sep="\t")
#write_csv(M9.2,file='data/M9.2_df.csv')



IC_10 = na.omit(IC_10)
labs = c('Na','Ca','Cl','SO4')
#level_order = c('Sodium','Calcium','Chloride','Sulphate')
conc_10 = ggplot(IC_10%>%filter(Stream=="Feed"), aes(x=Time, y=value,color= key))+geom_point()+geom_line()+
  scale_color_brewer(palette= "Set1")+scale_y_continuous(limits = c(0,1200))+
  labs(x="Time [h]",y="Ion Concentration Feed  [mg/L]", color="")+
  ggtitle("Ion concentration Multisalt pH 10")
p_conc_10 =  ggplotly(conc_10) %>% layout(showlegend = FALSE)


rej_10=ggplot(C_10, aes(x=time, y=value,color= key))+geom_point()+geom_line()+geom_hline(yintercept=0)+
  scale_color_brewer(palette= "Set1")+scale_y_continuous(limits = c(-0.6,1))+
  labs(x="Time [h]",y="Rejection", color="")+xlim(c(0,NA))+
  ggtitle("pH 10")
ggplotly(rej_10)
```
##### pH 10.5
```{r Ions 10.5, echo=FALSE}
IC_10.5_raw = IC_10.5 = as.data.frame(pH10.5_IC_data)
IC_10.5 = slice(IC_10.5,-c(14,15))
IC10.5p=IC_10.5 %>% filter(Stream=="Permeate")%>%mutate(Sulphate=5)
IC10.5f=IC_10.5 %>% filter(Stream=="Feed")
IC_10.5 = rbind(IC10.5f,IC10.5p)
M10.5=IC_10.5%>%filter(Stream =="Feed")%>%slice(-1)
#IC_10.5$Sulphate = replace_na(IC_10.5$Sulphate,5)
IC_10.5 = IC_10.5%>%gather(key,value, Sodium,Chloride,Sulphate,Calcium)

IC_10.5 = subset(IC_10.5,select=-c(5,6,7))
IC_10.5$value = as.double(IC_10.5$value)
IC_10.5$Time = as.double(IC_10.5$Time)
#IC_10.5 = IC_10.5%>%mutate(Rej = )
A=IC_10.5%>%filter(Stream == "Feed" & Time != 0)
B=IC_10.5%>%filter(Stream=="Permeate")
rejection = 1-B$value/A$value
C_10.5=data.frame(matrix(ncol=3,nrow=length(rejection)))
colnames(C_10.5)=c('time','key','value')
C_10.5$time=A$Time
C_10.5$key=A$key
C_10.5$value=rejection



## Export af data
M10.5 = cbind(M10.5, C_10.5 %>% filter(key =="Chloride")%>%select("value"))
M10.5 = cbind(M10.5, C_10.5 %>% filter(key =="Sulphate")%>%select("value"))
M10.5 = cbind(M10.5, C_10.5 %>% filter(key =="Sodium")%>%select("value"))
M10.5 = cbind(M10.5, C_10.5 %>% filter(key =="Calcium")%>%select("value"))
sil_10.5 = data.frame(pH10.5_rej_SiO2/10.50)
M10.5 = cbind(M10.5,sil_10.5[2:7,])



colnames(M10.5)=c("time","Stream","name","Na","Cl","SO4","Ca","SiO2_mgL","fuck","af","pls","Rej_Cl","Rej_SO4","Rej_Na","Rej_Ca","Rej_SiO2")
M10.5=M10.5%>%select(-c("Stream","fuck","af","pls"))
write.table(M10.5,file='data/M10.5_df.csv',col.names = T,row.names = F,sep="\t")
#write_csv(M9.2,file='data/M9.2_df.csv')


IC_10.5 = na.omit(IC_10.5)
labs = c('Na','Ca','Cl','SO4')
#level_order = c('Sodium','Calcium','Chloride','Sulphate')
conc_10.5= ggplot(IC_10.5%>%filter(Stream=="Feed"), aes(x=Time, y=value,color= key))+geom_point()+geom_line()+
  scale_color_brewer(palette= "Set1")+scale_y_continuous(limits = c(0,1200))+
  labs(x="Time [h]",y="Ion Concentration Feed  [mg/L]", color="")+
  ggtitle("Ion concentration Multisalt pH 10.5")
p_conc_10.5 =  ggplotly(conc_10.5) %>% layout(showlegend = T)



rejec_10.5=ggplot(C_10.5, aes(x=time, y=value,color= key))+geom_point()+geom_line()+geom_hline(yintercept=0)+
  scale_color_brewer(palette= "Set1")+scale_y_continuous(limits = c(-0.6,1))+
  labs(x="Time [h]",y="Rejection", color="")+xlim(c(0,NA))+
  ggtitle("pH 10.5")
p_rejec_10.5 <- rejec_10.5 %>% style(hovertemplate = paste('Rejection: %{y}',
                                                         '<br>Time: %{x} h'))
p_rejec_10.5
p_conc_10.5
```
### Comparison of results

```{r plot next to each other, echo=FALSE}
require(gridExtra)
require(ggpubr)

#grid.arrange(rej_9.2,rej_10,rejec_10.5,ncol=3)
ggarrange(rej_9.2,rej_10,rejec_10.5, ncol=3, nrow=1, common.legend = TRUE, legend="bottom",align = "v")
```

```{r}
subplot(p_conc_9.2,p_conc_10,p_conc_10.5,nrows = 1)
```


```{r Ions + Silica, echo=FALSE}
sil_9.2 = data.frame(c(3.5,5,6,7,8,8.7),"Silica",pH9.2_rej_SiO2/100)
sil_10 = data.frame(c(1.25,3,4,5,5.5,6,6.5),"Silica",pH10_rej_SiO2/100)
sil_10.5 = data.frame(c(2.5,4,5,6,7,8,8.17),"Silica",pH10.5_rej_SiO2/100)
colnames(sil_9.2)=colnames(sil_10)=colnames(sil_10.5)=c('time','key','value')

all_ion_9.2 = rbind(C_9.2,sil_9.2)
all_ion_10 = rbind(C_10,sil_10)
all_ion_10.5 = rbind(C_10.5,sil_10.5)


all_rejec_9.2=ggplot(all_ion_9.2, aes(x=time, y=value,color= key))+geom_point()+geom_line()+geom_hline(yintercept=0)+
  scale_color_brewer(palette= "Set1")+scale_y_continuous(limits = c(-0.6,1))+
  labs(x="Time [h]",y="Rejection", color="")+xlim(c(0,NA))+
  ggtitle("pH 9.2")


all_rejec_10=ggplot(all_ion_10, aes(x=time, y=value,color= key))+geom_point()+geom_line()+geom_hline(yintercept=0)+
  scale_color_brewer(palette= "Set1")+scale_y_continuous(limits = c(-0.6,1))+
  labs(x="Time [h]",y="Rejection", color="")+xlim(c(0,NA))+
  ggtitle("pH 10")

all_rejec_10.5=ggplot(all_ion_10.5, aes(x=time, y=value,color= key))+geom_point()+geom_line()+geom_hline(yintercept=0)+
  scale_color_brewer(palette= "Set1")+scale_y_continuous(limits = c(-0.6,1))+
  labs(x="Time [h]",y="Rejection", color="")+xlim(c(0,NA))+
  ggtitle("pH 10.5")


ggarrange(all_rejec_9.2,all_rejec_10,all_rejec_10.5, ncol=3, nrow=1, common.legend = TRUE, legend="bottom",align = "v")
#subplot(ggplotly(all_rejec_9.2),ggplotly(all_rejec_10),ggplotly(all_rejec_10.5),nrows = 1)
```


```{r Estimation of ionic ratios}
IC_9.2_B = IC_9.2_raw%>%filter(Stream == "Feed")%>%select(-c(3,9,10,11,12,13))
IC_9.2_B = na.omit(IC_9.2_B)

IC_9.2_B$Sodium = as.numeric(IC_9.2_B$Sodium)
IC_9.2_B = IC_9.2_B %>% mutate(Sulphate_mol = Sulphate/(96.06*10^3))
IC_9.2_B = IC_9.2_B %>% mutate(Sodium_mol = Sodium/(22.98*10^3))
IC_9.2_B = IC_9.2_B %>% mutate(Chloride_mol = Chloride/(35.453*10^3))
IC_9.2_B = IC_9.2_B %>% mutate(Calcium_mol = Calcium/(40*10^3))
IC_9.2_B = IC_9.2_B %>% mutate(Silica_mol = Silica/(60*10^3))


IC_9.2_B = IC_9.2_B %>% mutate(Na = Sodium_mol/(Sodium_mol+Calcium_mol)*100)
IC_9.2_B = IC_9.2_B %>% mutate(Cl = Chloride_mol/(Chloride_mol+Sulphate_mol)*100)




IC_10_B = IC_10_raw%>%filter(Stream == "Feed")%>%select(-c(3,9))
IC_10_B = na.omit(IC_10_B)

IC_10_B$Sodium = as.numeric(IC_10_B$Sodium)
IC_10_B = IC_10_B %>% mutate(Sulphate_mol = Sulphate/(96.06*10^3))
IC_10_B = IC_10_B %>% mutate(Sodium_mol = Sodium/(22.98*10^3))
IC_10_B = IC_10_B %>% mutate(Chloride_mol = Chloride/(35.453*10^3))
IC_10_B = IC_10_B %>% mutate(Calcium_mol = Calcium/(40*10^3))
IC_10_B = IC_10_B %>% mutate(Silica_mol = Silica/(60*10^3))

IC_10_B = IC_10_B %>% mutate(Na = Sodium_mol/(Sodium_mol+Calcium_mol)*100)
IC_10_B = IC_10_B %>% mutate(Cl = Chloride_mol/(Chloride_mol+Sulphate_mol)*100)





IC_10.5_B = IC_10.5_raw%>%filter(Stream == "Feed")%>%select(-c(3,9,10,11))
IC_10.5_B = na.omit(IC_10.5_B)

IC_10.5_B$Sodium = as.numeric(IC_10.5_B$Sodium)
IC_10.5_B = IC_10.5_B %>% mutate(Sulphate_mol = Sulphate/(96.06*10^3))
IC_10.5_B = IC_10.5_B %>% mutate(Sodium_mol = Sodium/(22.98*10^3))
IC_10.5_B = IC_10.5_B %>% mutate(Chloride_mol = Chloride/(35.453*10^3))
IC_10.5_B = IC_10.5_B %>% mutate(Calcium_mol = Calcium/(40*10^3))
IC_10.5_B = IC_10.5_B %>% mutate(Silica_mol = Silica/(60*10^3))

IC_10.5_B = IC_10.5_B %>% mutate(Na = Sodium_mol/(Sodium_mol+Calcium_mol)*100)
IC_10.5_B = IC_10.5_B %>% mutate(Cl = Chloride_mol/(Chloride_mol+Sulphate_mol)*100)

ratios = data.frame()
IC_9.2_C =data.frame(IC_9.2_B$Time,IC_9.2_B$Na,IC_9.2_B$Cl,IC_9.2_B$Silica)
IC_10_C =data.frame(IC_9.2_B$Time,IC_9.2_B$Na,IC_9.2_B$Cl,IC_10_B$Silica)
IC_10.5_C =data.frame(IC_10.5_B$Time,IC_10.5_B$Na,IC_10.5_B$Cl,IC_10.5_B$Silica)


#IC_9.2_C$cl_rejection = rbind(NA,all_ion_9.2%>%filter(key=="Chloride")%>%select(3))
#IC_10_C$cl_rejection = rbind(0,all_ion_10%>%filter(key=="Chloride")%>%select(3))
#IC_10.5_C$cl_rejection = rbind(NA,all_ion_10.5%>%filter(key=="Chloride")%>%select(3
IC_9.2_C=cbind(IC_9.2_C,rbind(NA,all_ion_9.2%>%filter(key=="Chloride")%>%select(3)))
IC_10_C=cbind(IC_10_C,rbind(NA,all_ion_10%>%filter(key=="Chloride")%>%select(3)))
IC_10.5_C=cbind(IC_10.5_C,rbind(NA,all_ion_10.5%>%filter(key=="Chloride")%>%select(3)))


IC_9.2_C$`Cl Rejection` = as.numeric(IC_9.2_C$`Cl Rejection`)
IC_9.2_C = na.omit(IC_9.2_C)
colnames(IC_9.2_C) = colnames(IC_10_C) = colnames(IC_10.5_C) = c("time","% Na","% Cl","Silica","Cl Rejection")


IC_9.2_D = na.omit(IC_9.2_C)%>%gather(key = key, value = value,"% Na","% Cl","Cl Rejection","Silica")
ion_comp_9.2 = ggplot(IC_9.2_D, aes(x = time, y = value) )+geom_point(aes(x = time, y = value,color = key))
p_ion_comp_9.2 = ggplotly(ion_comp_9.2)

IC_10_D = na.omit(IC_10_C)%>%gather(key = key, value = value,"% Na","% Cl","Cl Rejection","Silica")
ion_comp_10 = ggplot(IC_10_D, aes(x = time, y = value) )+geom_point(aes(x = time, y = value,color = key))
p_ion_comp_10 = ggplotly(ion_comp_10)

IC_10.5_D = na.omit(IC_10.5_C)%>%gather(key = key, value = value,"% Na","% Cl","Cl Rejection","Silica")
ion_comp_10.5 = ggplot(IC_10.5_D, aes(x = time, y = value) )+geom_point(aes(x = time, y = value,color = key))
p_ion_comp_10.5 = ggplotly(ion_comp_10.5)

subplot(ion_comp_9.2,ion_comp_10,ion_comp_10.5,nrows = 1)
ggarrange(ion_comp_9.2,ion_comp_10,ion_comp_10.5, ncol=3, nrow=1, common.legend = TRUE, legend="bottom",align = "v")

```



```{r Estimation of Sulphate concentration, eval=FALSE, include=FALSE}
IC_9.2_raw = as.data.frame(pH9.2_IC_data)
ion_values = data.frame(
  ions = c("Na", "Cl", "SO4", "Ca"),
  molar_con = c(50.1, 76.4, 160, 119),# Molær konduktivitet[S*cm^2*mol^-1]
  molar_weight = c(23,35.45,96,40)#g/mol
  )

IC_9.2 =IC_9.2_raw
IC_9.2$Sodium = as.double(IC_9.2$Sodium)
IC_9.2$Sodium = IC_9.2$Sodium/ion_values[1,3]
IC_9.2$Chloride = IC_9.2$Chloride /ion_values[2,3]
IC_9.2$Sulphate = IC_9.2$Sulphate / ion_values[3,3]
IC_9.2$Calcium = IC_9.2$Calcium / ion_values[4,3]
#nu er værdierne i mM?
mangler_sul = IC_9.2 %>% filter(is.na(Sulphate))
mangler_sul %>% mutate(con = (Sodium*ion_values[1,2]+Chloride*ion_values[2,2]+Calcium*ion_values[4,2]))
IC_9.2 = IC_9.2_raw%>%gather(key,value, Sodium,Chloride,Sulphate,Calcium)%>%filter(Stream=="Permeate")
IC_9.2$value = as.double(IC_9.2$value)

med_sul = IC_9.2 %>% filter(!is.na(Sulphate))
med_sul %>% mutate(con = (Sodium*ion_values[1,2]+Chloride*ion_values[2,2]+Sulphate*ion_values[3,2]+Calcium*ion_values[4,2])) %>%mutate(dCOn = Conductivity-con)
```
###Comparison to SPRR
```{r Estimation of ionic ratios}
IC_9.2_B = IC_9.2_raw %>% filter(Stream == "Feed") %>% select(-c(3, 9, 10, 11, 12, 13))
IC_9.2_B = na.omit(IC_9.2_B)
IC_9.2_B$Sodium = as.numeric(IC_9.2_B$Sodium)
IC_9.2_B = IC_9.2_B %>% mutate(Sulphate_mol = Sulphate / (96.06 * 10 ^ 3))
IC_9.2_B = IC_9.2_B %>% mutate(Sodium_mol = Sodium / (22.98 * 10 ^ 3))
IC_9.2_B = IC_9.2_B %>% mutate(Chloride_mol = Chloride / (35.453 * 10 ^
                                                            3))
IC_9.2_B = IC_9.2_B %>% mutate(Calcium_mol = Calcium / (40 * 10 ^ 3))
IC_9.2_B = IC_9.2_B %>% mutate(Na = Sodium_mol / (Sodium_mol + Calcium_mol) *
                                 100)
IC_9.2_B = IC_9.2_B %>% mutate(Cl = Chloride_mol / (Chloride_mol + Sulphate_mol) *
                                 100)
IC_10_B = IC_10_raw %>% filter(Stream == "Feed") %>% select(-c(3, 9))
IC_10_B = na.omit(IC_10_B)
IC_10_B$Sodium = as.numeric(IC_10_B$Sodium)
IC_10_B = IC_10_B %>% mutate(Sulphate_mol = Sulphate / (96.06 * 10 ^ 3))
IC_10_B = IC_10_B %>% mutate(Sodium_mol = Sodium / (22.98 * 10 ^ 3))
IC_10_B = IC_10_B %>% mutate(Chloride_mol = Chloride / (35.453 * 10 ^ 3))
IC_10_B = IC_10_B %>% mutate(Calcium_mol = Calcium / (40 * 10 ^ 3))
IC_10_B = IC_10_B %>% mutate(Na = Sodium_mol / (Sodium_mol + Calcium_mol) *
                               100)
IC_10_B = IC_10_B %>% mutate(Cl = Chloride_mol / (Chloride_mol + Sulphate_mol) *
                               100)
IC_10.5_B = IC_10.5_raw %>% filter(Stream == "Feed") %>% select(-c(3, 9, 10, 11))
IC_10.5_B = na.omit(IC_10.5_B)
IC_10.5_B$Sodium = as.numeric(IC_10.5_B$Sodium)
IC_10.5_B = IC_10.5_B %>% mutate(Sulphate_mol = Sulphate / (96.06 * 10 ^
                                                              3))
IC_10.5_B = IC_10.5_B %>% mutate(Sodium_mol = Sodium / (22.98 * 10 ^ 3))
IC_10.5_B = IC_10.5_B %>% mutate(Chloride_mol = Chloride / (35.453 * 10 ^
                                                              3))
IC_10.5_B = IC_10.5_B %>% mutate(Calcium_mol = Calcium / (40 * 10 ^ 3))
IC_10.5_B = IC_10.5_B %>% mutate(Na = Sodium_mol / (Sodium_mol + Calcium_mol) *
                                   100)
IC_10.5_B = IC_10.5_B %>% mutate(Cl = Chloride_mol / (Chloride_mol + Sulphate_mol) *
                                   100)
ratios = data.frame()
IC_9.2_C = data.frame(IC_9.2_B$Time, IC_9.2_B$Na, IC_9.2_B$Cl)
IC_10_C = cbind(IC_10_B$Time, IC_10_B$Na, IC_10_B$Cl)
IC_10.5_C = cbind(IC_10.5_B$Time, IC_10.5_B$Na, IC_10.5_B$Cl)
print(xtable(IC_10.5_C))

´´´
