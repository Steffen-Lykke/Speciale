---
title: "SPRR Databehandling"
author: "Lærke + Steffen"
date: "1/12/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

library(dplyr)
library(tidyr)
library(ggplot2)
library(visdat)
library(GGally)
library(Hmisc)
library(DMwR2)
library(data.table)
library(mltools)
library(ggfortify)
library(ggiraphExtra)
library(coronavirus)
library(lubridate)
library(plotly)
library(readxl)
require(readr)
library(zoo)
library(latex2exp)
library(fs)
library(fcuk)
colors = c(
    '#1f77b4',  # muted blue
    '#ff7f0e',  # safety orange
    '#2ca02c',  # cooked asparagus green
    '#d62728',  # brick red
    '#9467bd',  # muted purple
    '#8c564b',  # chestnut brown
    '#e377c2',  # raspberry yogurt pink
    '#7f7f7f',  # middle gray
    '#bcbd22',  # curry yellow-green
    '#17becf'   # blue-teal
)
```


## Databehandling SPRR {.tabset}


```{R import af data god, message=FALSE, include=FALSE}


SPRR_data <- read_excel("data/SPRR/SPRR_analysesvar_samlet.xlsx",3,col_names = T,
                        col_types=c("numeric","text","numeric","numeric","numeric","numeric","numeric","numeric","numeric","numeric","numeric"))
SPRR_data_raw=SPRR_data 
#Fuck med de rigtige Cl ratios
new_ratios_feed = SPRR_data %>% filter(Stream=="Feed")
new_ratios_feed =new_ratios_feed %>% mutate(acutal_cl_ratio = (Cl/35)/((SO4/96)+(Cl/35)))
new_ratios_feed = new_ratios_feed %>% mutate(acutal_na_ratio = (Na/23)/((Ca/40)+(Na/23)))
SPRR_data = SPRR_data %>% mutate(Cl_ratio=replace(Cl_ratio,Stream=="Feed",new_ratios_feed$acutal_cl_ratio)) 
SPRR_data = SPRR_data %>% mutate(Cl_ratio=replace(Cl_ratio,Stream=="Rejection",new_ratios_feed$acutal_cl_ratio))
SPRR_data = SPRR_data %>% mutate(Cl_ratio=replace(Cl_ratio,Stream=="Permeat",new_ratios_feed$acutal_cl_ratio))
SPRR_data = SPRR_data %>% mutate(Cl_ratio=Cl_ratio*100)
SPRR_data$HCO3[1:3] = 0
write.table(SPRR_data,file='data/SPRR_df.csv',col.names = T,row.names = F,sep="\t")
SPRR_wrangle = cbind(SPRR_data%>%filter(Stream == "Feed"),SPRR_data%>%filter(Stream == "Permeat")%>%select("Ca","Na","Cl","SO4","SiO2","HCO3"),SPRR_data%>%filter(Stream == "Rejection")%>%select("Ca","Na","Cl","SO4","SiO2","HCO3"))
colnames(SPRR_wrangle) = c("Experiment","Stream","Cl_ratio_1","SiO2_teo","pH","F_Ca","F_Na","F_Cl","F_SO4","F_SiO2","F_HCO3","P_Ca","P_Na","P_Cl","P_SO4","P_SiO2","P_HCO3","Rej_Ca","Rej_Na","Rej_Cl","Rej_SO4","Rej_SiO2","Rej_HCO3")
SPRR_data=SPRR_wrangle


SPRR_data$pH= c(9.33,9.37,9.26,NA,9.26,9.35,NA,9.67,9.68,NA,9.56,9.66,NA,9.83,9.89,NA,9.81,9.87)
SPRR_data$conductivity= c(4210,2350,1670,NA,2330,1680,NA,2440,1750,NA,2510,1760,NA,2450,1840,NA,2540,1830)

Mw_Cl=35.45
Mw_Na=22.99
Mw_Ca=40.078
Mw_SO4=96.06
Mw_SiO2=60.08
Mw_HCO3 =61.0168
#udregner alle concentrationer i mmmol. 
SPRR_data$F_Na=SPRR_data$F_Na/Mw_Na
SPRR_data$F_Ca=SPRR_data$F_Ca/Mw_Ca
SPRR_data$F_Cl=SPRR_data$F_Cl/Mw_Cl
SPRR_data$F_SO4=SPRR_data$F_SO4/Mw_SO4
SPRR_data$F_SiO2=SPRR_data$F_SiO2/Mw_SiO2
SPRR_data$F_HCO3=SPRR_data$F_HCO3/Mw_HCO3

SPRR_data$P_Na=SPRR_data$P_Na/Mw_Na
SPRR_data$P_Ca=SPRR_data$P_Ca/Mw_Ca
SPRR_data$P_Cl=SPRR_data$P_Cl/Mw_Cl
SPRR_data$P_SO4=SPRR_data$P_SO4/Mw_SO4
SPRR_data$P_SiO2=SPRR_data$P_SiO2/Mw_SiO2
SPRR_data$P_HCO3=SPRR_data$P_HCO3/Mw_HCO3
```

```{r Fra SPRR SUmmary, eval=FALSE, include=FALSE}


ggplotly(ggplot(Ion_data_frame, aes(x=SO4_anion, y=Rej_Cl,color=type))+geom_point()+
 geom_smooth(method = "lm")+
   ggtitle("Cl rejection Vs. SO4 anion %") +
  xlab("SO4 %") + ylab("Cl rejection")
 )

``` 


### 2D representation of data
#### Silica analyse
Det ses at højere pH leder til højere rejection af silica, både for silica concent på 75 mg/L og 125 mg/L. 
højere Cl% giver også højere silica rejection hvilken nok har noget at gøre med at silica så lettere bliver rejected når der er mindre SO4 til stede. 
Cl% er udregnet efter [Cl]/[SO4+CL]. -> Dette bør undersøges. 


```{R Plot af Silica , echo=FALSE, message=FALSE}


fig_1 <- ggplotly(ggplot(SPRR_data%>% filter(SiO2_teo=="75"), aes(x=Cl_ratio_1, y=Rej_SiO2,color=pH))+geom_point()+geom_line()+
            ggtitle("SiO2 rejection mod Cl ratio ")+
              labs( subtitle = "SiO2 75 mg/L")+
              xlab("Cl_ratio") +ylim(0,50)+
                ylab("SiO2 rejection")
 )

fig_2 <- ggplotly(ggplot(SPRR_data%>% filter(SiO2_teo=="125"), aes(x=Cl_ratio_1, y=Rej_SiO2,color=pH))+geom_point()+
            ggtitle("SiO2 rejection mod Cl ratio ")+
              labs( subtitle = "SiO2 75 mg/L")+
              xlab("Cl_ratio") + ylim(0,50)+
                ylab("SiO2 rejection")
 )


#fig_SiO2_Clratio <- subplot(fig_1,fig_2,nrows=1,titleY=TRUE,titleX=TRUE,margin=0.1)
#fig_SiO2_Clratio 

# Update title
annotations = list( 
  list( 
    x = 0.15,  
    y = 1.0,  
    text = "SIO2 75",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.85,  
    y = 1,  
    text = "SIO2 125",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ))

fig_SiO2_Clratio  <- subplot(fig_1,fig_2,nrows=1,titleY=TRUE,titleX=TRUE,margin=0.1)%>%layout(annotations = annotations) 


fig_SiO2_Clratio 


fig_pH <- ggplotly(ggplot(SPRR_data, aes(x=pH, y=Rej_SiO2,color=SiO2_teo))+geom_point()+geom_line()+
            ggtitle("SiO2 rejection mod pH ")+
              xlab("pH") +#ylim(0,50)+
                ylab("SiO2 rejection")
 )
fig_pH


```

Da der tydeligt ses tendens ml. silica rejeciton og pH laves en linær regression for SiO2 rejeciton og pH. 

Der udover er der en tendens til højere silica rejcetion ved højere feed concentraiton, dog har dette langt mindre effekt på rejection end pH. (der kan ikke findes noget belæg for at det kunne skyldes anion concentrationen frem for Silica.)


```{r Silica rej mod pH , echo=FALSE}

fit = lm(Rej_SiO2~pH, data = SPRR_data)
ggplotRegression <- function (fit) {

require(ggplot2)

ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                     "Intercept =",signif(fit$coef[[1]],5 ),
                     " Slope =",signif(fit$coef[[2]], 5),
                     " P =",signif(summary(fit)$coef[2,4], 5)))
}
ggplotRegression(fit)+labs( subtitle = "Alt data")

SPRR_data = SPRR_data%>%mutate(SiO2_ladet=((fit$coef)[2]*pH+(fit$coef)[1])/100*F_SiO2)


fit = lm(Rej_SiO2~pH, data = SPRR_data%>%filter(SiO2_teo==75))
ggplotRegression(fit)+labs( subtitle = "Alt data")

SPRR_data = SPRR_data%>%mutate(SiO2_ladet=((fit$coef)[2]*pH+(fit$coef)[1])/100*F_SiO2)


fit = lm(Rej_SiO2~pH, data = SPRR_data%>%filter(SiO2_teo==125))
ggplotRegression(fit)+labs( subtitle = "Alt data")

SPRR_data = SPRR_data%>%mutate(SiO2_ladet=((fit$coef)[2]*pH+(fit$coef)[1])/100*F_SiO2)





```
#### Chlorid analyse
Check af Cl/anion ratio. 
Det virker ikke til at det gør den store forskel på tendenser når der bruges forskellig cl/anion ratio til at predicte det med. Dog bliver Cl/anion ratioen mindre grundet flere anioner includeres.  

```{R Plot af CL/anion ratio, echo=FALSE, message=FALSE}


SPRR_data = SPRR_data%>%mutate(anion_total = F_Cl+F_SO4+F_SiO2+F_HCO3)
SPRR_data = SPRR_data%>%mutate(Cl_ratio_2=F_Cl/(F_Cl+F_SO4+F_SiO2)*100)
SPRR_data = SPRR_data%>%mutate(Cl_ratio_3=F_Cl/(F_Cl+F_SO4+F_SiO2+F_HCO3)*100)
SPRR_data = SPRR_data%>%mutate(Cl_ratio_4=F_Cl/(F_Cl+F_SO4+SiO2_ladet+F_HCO3)*100)

fig_1 <- ggplotly(ggplot(SPRR_data, aes(x=Cl_ratio_1, y=Rej_Cl,color=pH))+geom_point()+geom_line()+
            ggtitle("Cl rejection mod Cl/CL+SO4 ")+
              xlab("Cl/Cl+SO4") +#ylim(0,50)+
                ylab("Cl rejection")
 )

fig_2 <- ggplotly(ggplot(SPRR_data, aes(x=Cl_ratio_2, y=Rej_Cl,color=pH))+geom_point()+geom_line()+
            ggtitle("Cl rejection mod Cl/CL+SO4+SiO2 ")+
              xlab("Cl/Cl+SO4+SiO2") +#ylim(0,50)+
                ylab("Cl rejection")
 )

fig_3 <- ggplotly(ggplot(SPRR_data, aes(x=Cl_ratio_3, y=Rej_Cl,color=pH))+geom_point()+geom_line()+
            ggtitle("Cl rejection mod Cl/CL+SO4+SiO2+HCO3 ")+
              xlab("Cl/Cl+SO4+SiO2+HCO3") +#ylim(0,50)+
                ylab("Cl rejection")
 )

fig_4 <- ggplotly(ggplot(SPRR_data, aes(x=Cl_ratio_4, y=Rej_Cl,color=pH))+geom_point()+geom_line()+
            ggtitle("Cl rejection mod Cl/CL+SO4+SiO2_ladet+HCO3 ")+
              xlab("Cl/Cl+SO4+SiO2_ladet+HCO3") +#ylim(0,50)+
                ylab("Cl rejection")
 )

fig_Cl_Clratio  <- subplot(fig_1,fig_2,fig_3,nrows=1,titleY=TRUE,titleX=TRUE,margin=0.1)
fig_Cl_Clratio 

fig_1
fig_2
fig_3
fig_4

```

#### Calcium
The concentraiton of Ca is not accurate compared to expected, all experiments should have contained 0.5 mM Ca which instead varies from 0.28-0.02 mM, being significantly lower. 

```{R Plot af Calcium subplots, echo=FALSE, message=FALSE}


fig_3 <- ggplotly(ggplot(SPRR_data, aes(x=Experiment, y=F_Ca))+geom_point()+geom_line()+
            ggtitle("Concentraiton af Ca ")) 
fig_3


fig_3 <- ggplotly(ggplot(SPRR_data, aes(x=F_Ca, y=Rej_Cl,color=pH))+geom_point()+geom_line()+
            ggtitle("Rej cl mod Ca")) 
fig_3


```

```{R Plot af Calcium subplots, echo=FALSE, message=FALSE}


fig_3 <- ggplotly(
  ggplot(SPRR_data, aes(x=Experiment, y=Rej_Ca))+geom_point()+geom_line()+
            ggtitle("Concentraiton af Ca ")) 
fig_3


fig_3 <- ggplotly(ggplot(SPRR_data, aes(x=F_Ca, y=Rej_Cl,color=pH))+geom_point()+geom_line()+
            ggtitle("Rej cl mod Ca")) 
fig_3


```

### 3D Representation of Data

```{R 3D plot alle pH, echo=FALSE, message=FALSE, warning=FALSE, , echo=FALSE}

#SPRR_rejection <- na.omit((SPRR_data%>%filter(Stream == "Rejection")))
SPRR_rejection <- na.omit(SPRR_data)
library(reshape2)
x=SPRR_rejection$Rej_Cl
y=SPRR_rejection$F_SiO2
z=SPRR_rejection$Cl_ratio_1
pH=SPRR_rejection$pH


SPRR_3d_plot_data <- cbind(SPRR_rejection$Rej_Cl,SPRR_rejection$F_SiO2,SPRR_rejection$Cl_ratio_1,SPRR_rejection$pH)
colnames(SPRR_3d_plot_data) = c("Rej_Cl","F_SiO2","Cl_ratio_1","pH")
SPRR_3d_plot_data <- data.frame(SPRR_3d_plot_data)

#SPRR_3d_plot_data_9.25 = SPRR_rejection %>%select(c(3,4,5,8))%>%relocate(pH, .after = Cl)
#points = data.frame(SPRR_rejection$Cl_ratio,SPRR_rejection$Silica_content,SPRR_rejection$Cl,SPRR_rejection$pH)
#points =SPRR_3d_plot_data_9.25

#my_df <- points
#Vores linear model:
Rejection_lm <- lm(Rej_Cl ~ Cl_ratio_1 + F_SiO2,data=SPRR_3d_plot_data)
#Graph Resolution (more important for more complex shapes)
graph_reso <- 0.5

#Setup Axis
axis_x <- seq(min(SPRR_3d_plot_data$Cl_ratio_1), max(SPRR_3d_plot_data$Cl_ratio_1), by = graph_reso)
axis_y <- seq(min(SPRR_3d_plot_data$F_SiO2), max(SPRR_3d_plot_data$F_SiO2), by = graph_reso)

#Sample points
Rejection_lm_surface <- expand.grid(Cl_ratio_1 = axis_x,F_SiO2 = axis_y,KEEP.OUT.ATTRS = F)
Rejection_lm_surface$Rej_Cl <- predict.lm(Rejection_lm, newdata = Rejection_lm_surface)
Rejection_lm_surface <- acast(Rejection_lm_surface, F_SiO2 ~ Cl_ratio_1, value.var = "Rej_Cl") #y ~ x


R_plot <- plot_ly(
 SPRR_3d_plot_data,
  x = ~ Cl_ratio_1,
  y = ~ F_SiO2,
  z = ~ Rej_Cl,
  type = "scatter3d",
  mode = "markers",
  marker = list(
    color = ~ pH,
    colorscale = 'magma'
    )
)%>%layout(title = 'All pH')
R_plot = R_plot %>% style(hovertemplate = paste('Rejection: %{z}',
                                                '<br> Cl ratio: %{x}',
                                                '<br> SiO2 concentration: %{y} mg/L'
                                                )
                          )

R_plot <- add_trace(
  p = R_plot,
  z = Rejection_lm_surface,
  x = axis_x,
  y = axis_y,
  type = "surface",
  colorbar = list(title = 'Cl Rejection'),
  colorscale = 'magma'
)

R_plot

```
