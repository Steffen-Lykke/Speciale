---
title: "ICR_phase_2"
date: "25/3/2022"
output: 
  html_document:
    toc: true
    toc_depth: 3
editor_options: 
  markdown: 
    wrap: sentence

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=F,message=F)
#knitr::opts_chunk$set(include = FALSE)
library(plyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(visdat)
library(GGally)
library(Hmisc)
library(DMwR2)
library(data.table)
library(mltools)
library(ggfortify)
library(ggiraphExtra)
library(coronavirus)
library(lubridate)
library(plotly)
#library(naniar)
library(readxl)
require(readr)
library(zoo)
library(latex2exp)
library(fs)
library(plyr)
library(matrixStats)
library(haven)
library(sjmisc)
require(gridExtra)
require(ggpubr)

colors = c(
  '#1f77b4',  # muted blue
  '#ff7f0e',  # safety orange
  '#2ca02c',  # cooked asparagus green
  '#d62728',  # brick red
  '#9467bd',  # muted purple
  '#8c564b',  # chestnut brown
  '#e377c2',  # raspberry yogurt pink
  '#7f7f7f',  # middle gray
  '#bcbd22',  # curry yellow-green
  '#17becf'   # blue-teal
)
```


```{r PLC data ID: 5, echo=FALSE}
##### ICR ID: 5 ####
ICR_ID_5_raw = read_delim("data/ICR_phase_2_pH_7.7_15-03-2022 000000.csv",delim = ",", escape_double = FALSE, trim_ws = TRUE, skip = 3) #Hente data og få det til passe ned i en tabel

ICR_ID_5 = as.data.frame(ICR_ID_5_raw) #Ændrer strukturen af dataen til noget vi kan arbejde med
old_names=colnames(ICR_ID_5_raw) #Vi finder de gamle navne kolonnerne i dataen har 
new_names=c("Time","con0201","pH0201","con0301","flow0301",
            "p0301","p0302","p0501","con0501",
            "temp0501","p0601","temp0601","CV0301","pmp0301","pmp0501","flow_avg0301",
            "p_avg0301","p_avg0302",
            "p_avg0501","FT0302","weight0302","flow0501","weight0501","pH0301",
            "pH0501") #Vi finder på nogle lidt bedre nogle
ICR_ID_5 = ICR_ID_5 %>% rename_at(vars(old_names),~new_names) #Vi ændrer navnene til de nye
ICR_ID_5$Time = dmy_hms(ICR_ID_5$Time)#Vi ændrer formatet af 'dato' kolonnen til et standard format for tid og datoer istedet for at det bare er noget tekst
ICR_ID_5=ICR_ID_5[-c(1:28860),]

### Finde t=0 (fosøgsstart = der hvor flow er over 16 mL/min)
flow_boolean = ICR_ID_5$flow0501>16&ICR_ID_5$flow0501<30
start_tid = min(which(flow_boolean))
ICR_ID_5=ICR_ID_5[-c(1:start_tid),]
flow_boolean_slut = ICR_ID_5$flow0501<1
slut_tid = min(which(flow_boolean_slut))
ICR_ID_5=ICR_ID_5[-c(slut_tid:(nrow(ICR_ID_5)) ),]
### Tid i s fra forsøgs start
ICR_ID_5 = ICR_ID_5%>%
   mutate(sek=(
           as.numeric(as.POSIXct(ICR_ID_5$Time))-as.numeric(ICR_ID_5$Time[1], format='%Y-%m-%d %H:%M:%S'))
                )  
### TMP ###
ICR_ID_5 = ICR_ID_5 %>% mutate(TMP=(p_avg0301+p_avg0302)/2-p_avg0501)


ICR_ID_5 %>%
  plot_ly(x=~(sek)/3600,
          y=~TMP,
          name="TMP",
          type='scatter',
          mode='lines',
          line=list(color= colors[1]))%>%
  add_lines(x=~sek/3600,
          y=~pH0201,
          name=' pH',
          type='scatter',
          mode='line',
          line=list(color=colors[2]))%>%
add_lines(x=~sek/3600,
          y=~con0301,
          name='Conductivity',
          type='scatter',
          mode='line',
      line=list(color=colors[3]))%>%
  layout(title="PLC data ID: 5 ",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="value", range=c(NA,NA)),
         xaxis=list(title="Time [h]",range=c(0,8))
         ) 

```

```{r IC data ID: 5, echo=FALSE}


##### ICR vol 2 A silica ######
ICR_v2_A_silica = read_excel("data/ICR2.xlsx",2)
ICR_v2_A_silica = ICR_v2_A_silica[c(1:10,13:16),-c(2,3)]

ICR_v2_A = data.frame(
  name = NA,
  Na =NA,
  Cl =NA,
  SO4=NA,
  Ca=NA,
  SiO2mgL=NA,
  pH=NA,
  time=c(2,4,6,7),
  recovery=NA,
  startvol=NA,
  permvol=NA
)
ICR_v2_A$name = c("ICR_v2_A_2h","ICR_v2_A_4h","ICR_v2_A_6h","ICR_v2_A_7h")
ICR_v2_A$sio2_feed=ICR_v2_A_silica[c(2:5),2]
ICR_v2_A$sio2_perm=ICR_v2_A_silica[c(7:10),2]
ICR_v2_A=ICR_v2_A%>%mutate(Rej_sio2=1-(sio2_perm/sio2_feed))





```


```{r PLC data ID: 6, echo=FALSE}
##### ICR vol 2 A ID 6 ####
ICR_vol2_A_raw = read_delim("data/ICR_volume2_A_16-03-2022 084022.csv",delim = ",", escape_double = FALSE, trim_ws = TRUE, skip = 3) #Hente data og få det til passe ned i en tabel

ICR_vol2_A = as.data.frame(ICR_vol2_A_raw) #Ændrer strukturen af dataen til noget vi kan arbejde med
old_names=colnames(ICR_vol2_A_raw) #Vi finder de gamle navne kolonnerne i dataen har 
new_names=c("Time","con0201","pH0201","con0301","flow0301",
            "p0301","p0302","p0501","con0501",
            "temp0501","p0601","temp0601","CV0301","pmp0301","pmp0501","flow_avg0301",
            "p_avg0301","p_avg0302",
            "p_avg0501","FT0302","weight0302","flow0501","weight0501","pH0301",
            "pH0501") #Vi finder på nogle lidt bedre nogle
ICR_vol2_A = ICR_vol2_A %>% rename_at(vars(old_names),~new_names) #Vi ændrer navnene til de nye
ICR_vol2_A$Time = dmy_hms(ICR_vol2_A$Time)#Vi ændrer formatet af 'dato' kolonnen til et standard format for tid og datoer istedet for at det bare er noget tekst


### Finde t=0 (fosøgsstart = der hvor flow er over 16 mL/min)
flow_boolean = ICR_vol2_A$flow0501>16&ICR_vol2_A$flow0501<25
start_tid = min(which(flow_boolean))
ICR_vol2_A=ICR_vol2_A[-c(1:start_tid),]
flow_boolean_slut = ICR_vol2_A$flow0501<1
slut_tid = min(which(flow_boolean_slut))
ICR_vol2_A=ICR_vol2_A[-c(slut_tid:(nrow(ICR_vol2_A)) ),]
### Tid i s fra forsøgs start
ICR_vol2_A = ICR_vol2_A%>%
   mutate(sek=(
           as.numeric(as.POSIXct(ICR_vol2_A$Time))-as.numeric(ICR_vol2_A$Time[1], format='%Y-%m-%d %H:%M:%S'))
                )  

### TMP ###
ICR_vol2_A = ICR_vol2_A %>% mutate(TMP=(p_avg0301+p_avg0302)/2-p_avg0501)



ICR_vol2_A %>%
  plot_ly(x=~(sek)/3600,
          y=~TMP,
          name="TMP",
          type='scatter',
          mode='lines',
          line=list(color= colors[1]))%>%
  add_lines(x=~sek/3600,
          y=~pH0201,
          name=' pH',
          type='scatter',
          mode='line',
          line=list(color=colors[2]))%>%
add_lines(x=~sek/3600,
          y=~con0301,
          name='Conductivity',
          type='scatter',
          mode='line',
      line=list(color=colors[3]))%>%
  layout(title="PLC data ID: 6 ",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="value", range=c(NA,NA)),
         xaxis=list(title="Time [h]",range=c(0,8))
         ) 


```

```{r PLC data ID: 7, echo=FALSE}


##### ICR vol 2 B ID 7 ####
ICR_vol2_B_raw = read_delim("data/ICR_volume2_B_17-03-2022 084934.csv",delim = ",", escape_double = FALSE, trim_ws = TRUE, skip = 3) #Hente data og få det til passe ned i en tabel

ICR_vol2_B = as.data.frame(ICR_vol2_B_raw) #Ændrer strukturen af dataen til noget vi kan arbejde med
old_names=colnames(ICR_vol2_B_raw) #Vi finder de gamle navne kolonnerne i dataen har 
new_names=c("Time","con0201","pH0201","con0301","flow0301",
            "p0301","p0302","p0501","con0501",
            "temp0501","p0601","temp0601","CV0301","pmp0301","pmp0501","flow_avg0301",
            "p_avg0301","p_avg0302",
            "p_avg0501","FT0302","weight0302","flow0501","weight0501","pH0301",
            "pH0501") #Vi finder på nogle lidt bedre nogle
ICR_vol2_B = ICR_vol2_B %>% rename_at(vars(old_names),~new_names) #Vi ændrer navnene til de nye
ICR_vol2_B$Time = dmy_hms(ICR_vol2_B$Time)#Vi ændrer formatet af 'dato' kolonnen til et standard format for tid og datoer istedet for at det bare er noget tekst




### Finde t=0 (fosøgsstart = der hvor flow er over 16 mL/min)
 flow_boolean = ICR_vol2_B$flow0501>16&ICR_vol2_B$flow0501<25
 start_tid = min(which(flow_boolean))
 ICR_vol2_B=ICR_vol2_B[-c(1:start_tid),]
 #flow_boolean_slut = ICR_vol2_B$flow0501<1
# slut_tid = min(which(flow_boolean_slut))
 #ICR_vol2_B=ICR_vol2_B[-c(slut_tid:(nrow(ICR_vol2_B)) ),]
### Tid i s fra forsøgs start
ICR_vol2_B = ICR_vol2_B%>%
   mutate(sek=(
           as.numeric(as.POSIXct(ICR_vol2_B$Time))-as.numeric(ICR_vol2_B$Time[1], format='%Y-%m-%d %H:%M:%S'))
                )  
### TMP ###
ICR_vol2_B = ICR_vol2_B %>% mutate(TMP=(p_avg0301+p_avg0302)/2-p_avg0501)


ICR_vol2_B %>%
  plot_ly(x=~Time,
          y=~TMP,
          name="TMP",
          type='scatter',
          mode='lines',
          line=list(color= colors[1]))%>%
  add_lines(x=~Time,
          y=~pH0201,
          name=' pH',
          type='scatter',
          mode='line',
          line=list(color=colors[2]))%>%
add_lines(x=~Time,
          y=~con0301,
          name='Conductivity',
          type='scatter',
          mode='line',
      line=list(color=colors[3]))%>%
  layout(title="PLC data ID: 7",
         legend=list(x=0.9,y=0.9),
         yaxis=list(title="value", range=c(NA,NA)),
         xaxis=list(title="Time [h]",range=c(NA,NA))
         ) 

``` 


```{r Import IC data, include=FALSE}

ICR_2_Ion_data_frame = data.frame()

#import af ID 5
ID_5 = read_excel("data/ICR/ICR_2_samlet.xlsx",2)
ID_5_raw=ID_5
ID_5$start_vol = 10

#import af ID 6
ID_6 = read_excel("data/ICR/ICR_2_samlet.xlsx",3)
ID_6_raw=ID_6
ID_6$start_vol = 10


#sæt dem sammen. 
ICR_2_Ion_data_frame = rbind(ID_5,ID_6)
FCT_Ion_data_frame$rej_SiO2=((1-(FCT_Ion_data_frame$Perm_SiO2/FCT_Ion_data_frame$Feed_SiO2))*100)


### noget med recovery
FCT_Ion_data_frame = FCT_Ion_data_frame%>%mutate("perm_vol"=tid*1.02)
FCT_Ion_data_frame = FCT_Ion_data_frame%>%mutate("Recovery"=100*(1-(start_vol-perm_vol)/start_vol))


Mw_Cl=35.45
Mw_Na=22.99
Mw_Ca=40.078
Mw_SO4=96.06
Mw_SiO2=60.08
#vi konvertere senere.... 
#Ion_data_frame = Ion_data_frame%>%mutate("Na_mmol"=Na/Mw_Na)
#Ion_data_frame = Ion_data_frame%>%mutate("Ca_mmol"=Ca/Mw_Ca)
#Ion_data_frame = Ion_data_frame%>%mutate("Cl_mmol"=Cl/Mw_Cl)
#Ion_data_frame = Ion_data_frame%>%mutate("SO4_mmol"=SO4/Mw_SO4)
#Ion_data_frame = Ion_data_frame%>%mutate("SiO2_mmol"=SiO2_mgL/Mw_SiO2)

``` 


```{R ICRv2 plot PLCdata, echo=FALSE, include=FALSE}

ICR_v2_A_silica = read_excel("data/ICR2.xlsx",2)
ICR_v2_A_silica = ICR_v2_A_silica[c(1:10,13:16),-c(2,3)]

ICR_v2_A = data.frame(
  name = NA,
  Na =NA,
  Cl =NA,
  SO4=NA,
  Ca=NA,
  SiO2mgL=NA,
  pH=NA,
  time=c(2,4,6,7),
  recovery=NA,
  startvol=NA,
  permvol=NA
)
ICR_v2_A$name = c("ICR_v2_A_2h","ICR_v2_A_4h","ICR_v2_A_6h","ICR_v2_A_7h")
ICR_v2_A$sio2_feed=ICR_v2_A_silica[c(2:5),2]
ICR_v2_A$sio2_perm=ICR_v2_A_silica[c(7:10),2]
ICR_v2_A=ICR_v2_A%>%mutate(Rej_sio2=1-(sio2_perm/sio2_feed))




```

